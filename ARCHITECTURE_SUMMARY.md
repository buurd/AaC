# Architecture as Code: Project Summary

This document summarizes the "Architecture as Code" approach we have implemented for our Webshop system. We have established a pipeline that ensures our implementation (Java code) remains in sync with our architectural model (Structurizr) and requirements.

## 1. The Architecture

We are building a simple **Webshop System** following the **C4 Model** for software architecture.

### System Context (Level 1)
*   **Webshop System**: The main software system.
*   **Customer**: A person who uses the Webshop.

### Containers (Level 2)
The Webshop system is composed of two main containers:
1.  **Web Server**: A Java application (running on Java 21) that handles HTTP requests.
2.  **Database**: A PostgreSQL database that stores product information.

### Components (Level 3)
Inside the Web Server container, we have defined the following components:
1.  **ProductController**: Handles the `/products` API endpoint.
2.  **ProductRepository**: Manages data access to the database.

### Code (Level 4)
We have implemented the domain model:
*   **Product**: A domain entity representing a product in the shop.

---

## 2. Requirements & Traceability

We define our requirements as code (YAML), allowing us to trace them from high-level goals down to specific code implementations.

| ID | Level | Description | Traceability |
| :--- | :--- | :--- | :--- |
| **REQ-001** | Context | Customer uses the Webshop system. | N/A |
| **REQ-002** | Context | Webshop is implemented as a Maven project. | N/A |
| **REQ-003** | Container | Webshop has a Web Server container. | Traces to REQ-001 |
| **REQ-004** | Container | Webshop has a Database container. | Traces to REQ-001 |
| **REQ-005** | Runtime | WebServer is accessible via HTTP (200 OK). | Traces to REQ-003 |
| **REQ-006** | Component | WebServer has a ProductController component. | Traces to REQ-003 |
| **REQ-007** | Runtime | `/products` endpoint returns a list of products. | Traces to REQ-006 |
| **REQ-008** | Code | `Product` domain entity exists with specific fields. | Traces to REQ-006 |
| **REQ-009** | Component | ProductController uses ProductRepository. | Traces to REQ-006 |

---

## 3. Automated Validations

We have built a `validate-architecture.sh` script that runs a series of automated checks to enforce our architecture. If any check fails, the build fails.

### A. Static Analysis (OPA & Rego)
We use **Open Policy Agent (OPA)** to validate our architecture model and code against our requirements.

1.  **Traceability Validation**: Ensures all requirements (except top-level ones) trace back to a parent requirement.
2.  **Relation Validation**: Verifies that the relationships defined in requirements (e.g., Customer -> WebServer) exist in the Structurizr model.
3.  **Container Validation**: Verifies that the required containers (WebServer, Database) exist in the model.
4.  **Component Validation**: Verifies that required components (ProductController) exist in the model.
5.  **Implementation Validation**: Checks that the expected files (e.g., `pom.xml`, `ProductController.java`) actually exist in the project structure.
6.  **Code Structure Validation**: Parses Java files to ensure classes have the required fields (e.g., `Product` has `id`, `name`, `price`).
7.  **Dependency Validation**: Scans Java code to ensure components correctly depend on each other (e.g., `ProductController` imports/uses `ProductRepository`).

### B. Runtime Verification
We spin up the actual application and database in Docker containers to verify the system works as expected.

1.  **Build**: Compiles the Java application using a Maven Docker container.
2.  **Infrastructure**: Starts a PostgreSQL database container and initializes the schema.
3.  **Deployment**: Starts the Webshop application container, connected to the database.
4.  **Health Check**: Verifies the root URL returns `200 OK`.
5.  **Functional Check**: Verifies the `/products` endpoint returns a valid list of products (e.g., "The Hitchhiker's Guide to the Galaxy").

---

## 4. Visualizing the Architecture

We use **Structurizr** to visualize our model. The DSL file (`workspace.dsl`) is the source of truth for these diagrams.

*(Note: These are descriptions of the views generated by Structurizr)*

*   **System Landscape View**: Shows the Customer and the Webshop System.
*   **Container View**: Shows the Web Server and Database containers inside the Webshop.
*   **Component View**: Shows the Controller and Repository components inside the Web Server.

---

## Conclusion

We have successfully created a **closed-loop feedback system** for our architecture.
*   **Requirements** drive the **Model**.
*   **Model** drives the **Implementation**.
*   **Automated Tests** verify that **Code matches Model** and **Model matches Requirements**.

This ensures that our architectural documentation never goes stale and that our implementation always adheres to the intended design.
