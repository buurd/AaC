<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderApplication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.order</a> &gt; <span class="el_source">OrderApplication.java</span></div><h1>OrderApplication.java</h1><pre class="source lang-java linenums">package com.example.order;

import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.URI;
import java.net.URLDecoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.Executors;
import java.net.URLEncoder;

<span class="nc" id="L30">public class OrderApplication {</span>

<span class="nc" id="L32">    private static final Logger logger = LoggerFactory.getLogger(OrderApplication.class);</span>

    private static final String CSS = 
        &quot;body { font-family: Arial, Helvetica, sans-serif; background-color: #F8F9FA; color: #343A40; margin: 0; padding: 20px; }&quot; +
        &quot;.container { max-width: 1200px; margin: 0 auto; background-color: #FFFFFF; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }&quot; +
        &quot;h1 { color: #343A40; }&quot; +
        &quot;.btn { display: inline-block; padding: 10px 20px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; }&quot; +
        &quot;.btn-primary { background-color: #007BFF; }&quot; +
        &quot;.btn-secondary { background-color: #6C757D; }&quot; +
        &quot;input[type='text'], input[type='password'] { padding: 8px; border: 1px solid #CED4DA; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }&quot; +
        &quot;label { display: block; font-weight: bold; margin-bottom: 5px; }&quot;;

    public static void main(String[] args) throws IOException, SQLException {
        // --- Database Setup ---
<span class="nc" id="L46">        String dbUrl = System.getenv().getOrDefault(&quot;DB_URL&quot;, &quot;jdbc:postgresql://localhost:5432/postgres&quot;);</span>
<span class="nc" id="L47">        String dbUser = System.getenv().getOrDefault(&quot;DB_USER&quot;, &quot;postgres&quot;);</span>
<span class="nc" id="L48">        String dbPassword = System.getenv().getOrDefault(&quot;DB_PASSWORD&quot;, &quot;postgres&quot;);</span>

        // Security Setup
<span class="nc" id="L51">        String jwksUrl = System.getenv().getOrDefault(&quot;JWKS_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/certs&quot;);</span>
<span class="nc" id="L52">        String issuer = System.getenv().getOrDefault(&quot;ISSUER_URL&quot;, &quot;https://localhost:8446/realms/webshop-realm&quot;);</span>
<span class="nc" id="L53">        String tokenUrl = System.getenv().getOrDefault(&quot;TOKEN_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/token&quot;);</span>
        // KEYCLOAK_URL is now derived dynamically if possible, or falls back to env
<span class="nc" id="L55">        String defaultKeycloakUrl = System.getenv().getOrDefault(&quot;KEYCLOAK_URL&quot;, &quot;https://localhost:8446&quot;);</span>

<span class="nc" id="L57">        logger.info(&quot;Connecting to database at: {}&quot;, dbUrl);</span>
<span class="nc" id="L58">        Connection connection = DriverManager.getConnection(dbUrl, dbUser, dbPassword);</span>
<span class="nc" id="L59">        logger.info(&quot;Database connection successful.&quot;);</span>

        // Initialize schema
<span class="nc" id="L62">        try (InputStream is = OrderApplication.class.getResourceAsStream(&quot;/schema.sql&quot;)) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L64">                throw new IOException(&quot;Cannot find schema.sql in resources.&quot;);</span>
            }
<span class="nc" id="L66">            String schemaSql = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L67">            try (Statement stmt = connection.createStatement()) {</span>
<span class="nc" id="L68">                String[] statements = schemaSql.split(&quot;;&quot;);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                for (String sql : statements) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">                    if (!sql.trim().isEmpty()) {</span>
<span class="nc" id="L71">                        stmt.execute(sql);</span>
                    }
                }
<span class="nc" id="L74">                logger.info(&quot;Database schema initialized.&quot;);</span>
            }
        }

<span class="nc" id="L78">        OrderRepository repository = new OrderRepository(connection);</span>
<span class="nc" id="L79">        InvoiceRepository invoiceRepository = new InvoiceRepository(connection);</span>
<span class="nc" id="L80">        StockReservationService stockService = new StockReservationService();</span>
<span class="nc" id="L81">        OrderFulfillmentService fulfillmentService = new OrderFulfillmentService();</span>
<span class="nc" id="L82">        CreditService creditService = new CreditService(invoiceRepository);</span>
<span class="nc" id="L83">        LoyaltyIntegrationService loyaltyService = new LoyaltyIntegrationService();</span>
        
<span class="nc" id="L85">        SecurityFilter managerFilter = new SecurityFilter(jwksUrl, issuer, &quot;order-manager&quot;);</span>
<span class="nc" id="L86">        SecurityFilter historyFilter = new SecurityFilter(jwksUrl, issuer, &quot;order-history&quot;);</span>

        // --- HTTP Server Setup ---
<span class="nc" id="L89">        int port = 8003;</span>
<span class="nc" id="L90">        HttpServer server = HttpServer.create(new InetSocketAddress(port), 0);</span>
        
<span class="nc" id="L92">        server.createContext(&quot;/&quot;, (exchange) -&gt; {</span>
<span class="nc" id="L93">            String path = exchange.getRequestURI().getPath();</span>
<span class="nc" id="L94">            logger.info(&quot;Received request: {} {}&quot;, exchange.getRequestMethod(), path);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (&quot;/&quot;.equals(path)) {</span>
<span class="nc" id="L96">                String header = &quot;&lt;div style='display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;'&gt;&quot; +</span>
                                &quot;&lt;button onclick=\&quot;window.location.href='/'\&quot; class='btn btn-primary'&gt;Order Dashboard&lt;/button&gt;&quot; +
                                &quot;&lt;button onclick=\&quot;window.location.href='/logout'\&quot; class='btn btn-secondary'&gt;Logout&lt;/button&gt;&quot; +
                                &quot;&lt;/div&gt;&quot;;

<span class="nc" id="L101">                String html = &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot; + CSS + &quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot; +</span>
                              header +
                              &quot;&lt;h1&gt;Order Service&lt;/h1&gt;&quot; +
                              &quot;&lt;p&gt;Manage customer orders.&lt;/p&gt;&quot; +
                              &quot;&lt;button onclick=\&quot;window.location.href='/orders'\&quot; class='btn btn-primary'&gt;View Orders&lt;/button&gt;&quot; +
                              &quot;&lt;button onclick=\&quot;window.location.href='/invoices'\&quot; class='btn btn-primary'&gt;View Invoices&lt;/button&gt;&quot; +
                              &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L108">                byte[] bytes = html.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L109">                exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="nc" id="L110">                exchange.sendResponseHeaders(200, bytes.length);</span>
<span class="nc" id="L111">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L112">                    os.write(bytes);</span>
                }
<span class="nc" id="L114">            } else {</span>
<span class="nc" id="L115">                String response = &quot;404 Not Found&quot;;</span>
<span class="nc" id="L116">                exchange.sendResponseHeaders(404, response.length());</span>
<span class="nc" id="L117">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L118">                    os.write(response.getBytes());</span>
                }
            }
<span class="nc" id="L121">            exchange.close();</span>
<span class="nc" id="L122">        });</span>
        
<span class="nc" id="L124">        server.createContext(&quot;/login&quot;, new LoginHandler(tokenUrl));</span>
        
<span class="nc" id="L126">        server.createContext(&quot;/logout&quot;, (exchange) -&gt; {</span>
<span class="nc" id="L127">            String path = exchange.getRequestURI().getPath();</span>
<span class="nc" id="L128">            logger.info(&quot;Received request: {} {}&quot;, exchange.getRequestMethod(), path);</span>
            
<span class="nc" id="L130">            String host = exchange.getRequestHeaders().getFirst(&quot;Host&quot;);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (host == null) host = &quot;localhost:8447&quot;;</span>
<span class="nc" id="L132">            String baseUrl = &quot;https://&quot; + host;</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if (baseUrl.endsWith(&quot;/&quot;)) baseUrl = baseUrl.substring(0, baseUrl.length() - 1);</span>

            // Derive Keycloak URL from Host if possible (replace 8447 with 8446)
<span class="nc" id="L136">            String currentKeycloakUrl = defaultKeycloakUrl;</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (host.contains(&quot;:8447&quot;)) {</span>
<span class="nc" id="L138">                currentKeycloakUrl = &quot;https://&quot; + host.replace(&quot;:8447&quot;, &quot;:8446&quot;);</span>
            }

            // Ensure redirect_uri is URL encoded
<span class="nc" id="L142">            String encodedRedirectUri = URLEncoder.encode(baseUrl + &quot;/&quot;, StandardCharsets.UTF_8);</span>
            // Corrected to use post_logout_redirect_uri
<span class="nc" id="L144">            String keycloakLogoutUrl = currentKeycloakUrl + &quot;/realms/webshop-realm/protocol/openid-connect/logout?post_logout_redirect_uri=&quot; + encodedRedirectUri + &quot;&amp;client_id=order-client&quot;;</span>

            // Clear cookie
<span class="nc" id="L147">            exchange.getResponseHeaders().add(&quot;Set-Cookie&quot;, &quot;auth_token=; Path=/; Max-Age=0&quot;);</span>
            
            // Redirect
<span class="nc" id="L150">            exchange.getResponseHeaders().set(&quot;Location&quot;, keycloakLogoutUrl);</span>
<span class="nc" id="L151">            exchange.sendResponseHeaders(302, -1);</span>
<span class="nc" id="L152">            exchange.close();</span>
<span class="nc" id="L153">        });</span>
        
        // Mount UI context (protected by order-manager)
<span class="nc" id="L156">        HttpContext ordersContext = server.createContext(&quot;/orders&quot;, new OrderController(repository, stockService, fulfillmentService, creditService, invoiceRepository, loyaltyService));</span>
<span class="nc" id="L157">        ordersContext.getFilters().add(managerFilter);</span>
        
        // Mount Invoices context (protected by order-manager)
<span class="nc" id="L160">        HttpContext invoicesContext = server.createContext(&quot;/invoices&quot;, new InvoiceController(invoiceRepository, repository));</span>
<span class="nc" id="L161">        invoicesContext.getFilters().add(managerFilter);</span>
        
        // Mount API context (protected by order-history)
<span class="nc" id="L164">        HttpContext apiContext = server.createContext(&quot;/api/orders&quot;, new OrderController(repository, stockService, fulfillmentService, creditService, invoiceRepository, loyaltyService));</span>
<span class="nc" id="L165">        apiContext.getFilters().add(historyFilter);</span>
        
<span class="nc" id="L167">        server.setExecutor(Executors.newCachedThreadPool());</span>
<span class="nc" id="L168">        server.start();</span>
<span class="nc" id="L169">        logger.info(&quot;Order Service started on port {}&quot;, port);</span>
<span class="nc" id="L170">    }</span>

    static class LoginHandler implements HttpHandler {
        private final String tokenUrl;
        private final HttpClient httpClient;

<span class="nc" id="L176">        public LoginHandler(String tokenUrl) {</span>
<span class="nc" id="L177">            this.tokenUrl = tokenUrl;</span>
<span class="nc" id="L178">            this.httpClient = HttpClient.newBuilder().connectTimeout(Duration.ofSeconds(5)).build();</span>
<span class="nc" id="L179">        }</span>

        @Override
        public void handle(HttpExchange t) throws IOException {
<span class="nc" id="L183">            logger.info(&quot;Received request: {} {}&quot;, t.getRequestMethod(), t.getRequestURI().getPath());</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (&quot;POST&quot;.equalsIgnoreCase(t.getRequestMethod())) {</span>
<span class="nc" id="L185">                InputStream is = t.getRequestBody();</span>
<span class="nc" id="L186">                String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L187">                Map&lt;String, String&gt; params = parseFormData(formData);</span>
                
<span class="nc" id="L189">                String username = params.get(&quot;username&quot;);</span>
<span class="nc" id="L190">                String password = params.get(&quot;password&quot;);</span>
                
<span class="nc" id="L192">                String requestBody = &quot;client_id=webshop-client&amp;grant_type=password&amp;username=&quot; + username + &quot;&amp;password=&quot; + password;</span>
                
<span class="nc" id="L194">                HttpRequest request = HttpRequest.newBuilder()</span>
<span class="nc" id="L195">                        .uri(URI.create(tokenUrl))</span>
<span class="nc" id="L196">                        .header(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;)</span>
<span class="nc" id="L197">                        .POST(HttpRequest.BodyPublishers.ofString(requestBody))</span>
<span class="nc" id="L198">                        .build();</span>
                
                try {
<span class="nc" id="L201">                    HttpResponse&lt;String&gt; response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">                    if (response.statusCode() == 200) {</span>
<span class="nc" id="L203">                        String json = response.body();</span>
<span class="nc" id="L204">                        String accessToken = extractToken(json);</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">                        logger.info(&quot;Access Token obtained: {}&quot;, accessToken != null &amp;&amp; !accessToken.isEmpty());</span>
                        // Changed cookie name to auth_token for SSO
<span class="nc" id="L207">                        t.getResponseHeaders().add(&quot;Set-Cookie&quot;, &quot;auth_token=&quot; + accessToken + &quot;; Path=/; HttpOnly&quot;);</span>
<span class="nc" id="L208">                        redirect(t, &quot;/orders&quot;); // Redirect to orders</span>
<span class="nc" id="L209">                    } else {</span>
<span class="nc" id="L210">                        logger.warn(&quot;Login failed for user: {}. Status: {}. Body: {}&quot;, username, response.statusCode(), response.body());</span>
<span class="nc" id="L211">                        sendResponse(t, 401, &quot;&lt;h1&gt;Login Failed&lt;/h1&gt;&lt;p&gt;Invalid credentials&lt;/p&gt;&lt;button onclick=\&quot;window.location.href='/login'\&quot; class='btn btn-primary'&gt;Try Again&lt;/button&gt;&quot;);</span>
                    }
<span class="nc" id="L213">                } catch (InterruptedException e) {</span>
<span class="nc" id="L214">                    logger.error(&quot;Error during login&quot;, e);</span>
<span class="nc" id="L215">                    sendResponse(t, 500, &quot;&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;&quot; + e.getMessage() + &quot;&lt;/p&gt;&quot;);</span>
<span class="nc" id="L216">                }</span>
<span class="nc" id="L217">            } else {</span>
<span class="nc" id="L218">                String body = &quot;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot; + CSS + &quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&lt;h1&gt;Login&lt;/h1&gt;&quot; +</span>
                              &quot;&lt;form action='/login' method='post'&gt;&quot; +
                              &quot;&lt;label&gt;Username&lt;/label&gt;&lt;input type='text' name='username'&gt;&quot; +
                              &quot;&lt;label&gt;Password&lt;/label&gt;&lt;input type='password' name='password'&gt;&quot; +
                              &quot;&lt;button type='submit' class='btn btn-primary'&gt;Login&lt;/button&gt;&quot; +
                              &quot;&lt;/form&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L224">                sendResponse(t, 200, body);</span>
            }
<span class="nc" id="L226">        }</span>

        private String extractToken(String json) {
<span class="nc" id="L229">            int start = json.indexOf(&quot;\&quot;access_token\&quot;:\&quot;&quot;);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (start == -1) return null;</span>
<span class="nc" id="L231">            start += 16;</span>
<span class="nc" id="L232">            int end = json.indexOf(&quot;\&quot;&quot;, start);</span>
<span class="nc" id="L233">            return json.substring(start, end);</span>
        }
    }

    private static void sendResponse(HttpExchange t, int status, String body) throws IOException {
<span class="nc" id="L238">        byte[] bytes = body.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L239">        t.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="nc" id="L240">        t.sendResponseHeaders(status, bytes.length);</span>
<span class="nc" id="L241">        try (OutputStream os = t.getResponseBody()) {</span>
<span class="nc" id="L242">            os.write(bytes);</span>
        }
<span class="nc" id="L244">    }</span>

    private static void redirect(HttpExchange t, String location) throws IOException {
<span class="nc" id="L247">        logger.info(&quot;Redirecting to: {}&quot;, location);</span>
<span class="nc" id="L248">        t.getResponseHeaders().set(&quot;Location&quot;, location);</span>
<span class="nc" id="L249">        t.sendResponseHeaders(302, -1);</span>
<span class="nc" id="L250">    }</span>

    private static Map&lt;String, String&gt; parseFormData(String formData) {
<span class="nc" id="L253">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L254">        String[] pairs = formData.split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        for (String pair : pairs) {</span>
<span class="nc" id="L256">            String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (keyValue.length &gt; 0) {</span>
<span class="nc" id="L258">                String key = URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                String value = keyValue.length &gt; 1 ? URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8) : &quot;&quot;;</span>
<span class="nc" id="L260">                map.put(key, value);</span>
            }
        }
<span class="nc" id="L263">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>