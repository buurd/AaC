<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.order</a> &gt; <span class="el_source">OrderController.java</span></div><h1>OrderController.java</h1><pre class="source lang-java linenums">package com.example.order;

import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.charset.StandardCharsets;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class OrderController implements HttpHandler {

    private final OrderRepository repository;
    private final StockReservationService stockService;
    private final OrderFulfillmentService fulfillmentService;
    private final CreditService creditService;
    private final InvoiceRepository invoiceRepository;
    private final LoyaltyIntegrationService loyaltyService;

<span class="fc" id="L28">    public OrderController(OrderRepository repository, StockReservationService stockService, OrderFulfillmentService fulfillmentService, CreditService creditService, InvoiceRepository invoiceRepository, LoyaltyIntegrationService loyaltyService) {</span>
<span class="fc" id="L29">        this.repository = repository;</span>
<span class="fc" id="L30">        this.stockService = stockService;</span>
<span class="fc" id="L31">        this.fulfillmentService = fulfillmentService;</span>
<span class="fc" id="L32">        this.creditService = creditService;</span>
<span class="fc" id="L33">        this.invoiceRepository = invoiceRepository;</span>
<span class="fc" id="L34">        this.loyaltyService = loyaltyService;</span>
<span class="fc" id="L35">    }</span>

    // Constructor for backward compatibility (if needed by tests not yet updated)
    public OrderController(OrderRepository repository, StockReservationService stockService, OrderFulfillmentService fulfillmentService, CreditService creditService, InvoiceRepository invoiceRepository) {
<span class="fc" id="L39">        this(repository, stockService, fulfillmentService, creditService, invoiceRepository, new LoyaltyIntegrationService());</span>
<span class="fc" id="L40">    }</span>

    private static final String CSS = 
        &quot;body { font-family: Arial, Helvetica, sans-serif; background-color: #F8F9FA; color: #343A40; margin: 0; padding: 20px; }&quot; +
        &quot;.container { max-width: 1200px; margin: 0 auto; background-color: #FFFFFF; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }&quot; +
        &quot;h1 { color: #343A40; }&quot; +
        &quot;table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }&quot; +
        &quot;th { background-color: #007BFF; color: #FFFFFF; padding: 12px; text-align: left; }&quot; +
        &quot;td { padding: 12px; border-bottom: 1px solid #DEE2E6; }&quot; +
        &quot;tr:nth-child(even) { background-color: #F2F2F2; }&quot; +
        &quot;.btn { display: inline-block; padding: 10px 20px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; }&quot; +
        &quot;.btn-secondary { background-color: #6C757D; }&quot; +
        &quot;.btn-success { background-color: #28A745; }&quot; +
        &quot;.btn-primary { background-color: #007BFF; }&quot;;

    private String getHeader() {
<span class="nc" id="L56">        return &quot;&lt;div style='display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;'&gt;&quot; +</span>
               &quot;&lt;button onclick=\&quot;window.location.href='/'\&quot; class='btn btn-primary'&gt;Order Dashboard&lt;/button&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/logout'\&quot; class='btn btn-secondary'&gt;Logout&lt;/button&gt;&quot; +
               &quot;&lt;/div&gt;&quot;;
    }

    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L64">        String method = exchange.getRequestMethod();</span>
<span class="fc" id="L65">        String path = exchange.getRequestURI().getPath();</span>

<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (&quot;/orders&quot;.equals(path)) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="nc" id="L69">                handleListOrders(exchange);</span>
            } else {
<span class="nc" id="L71">                exchange.sendResponseHeaders(405, -1);</span>
            }
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        } else if (&quot;/orders/confirm&quot;.equals(path)) {</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">            if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="nc" id="L75">                handleConfirmOrder(exchange);</span>
            } else {
<span class="nc" id="L77">                exchange.sendResponseHeaders(405, -1);</span>
            }
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        } else if (&quot;/api/orders&quot;.equals(path)) {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L81">                handleApiListOrders(exchange);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L83">                handleCreateOrder(exchange);</span>
            } else {
<span class="nc" id="L85">                exchange.sendResponseHeaders(405, -1);</span>
            }
<span class="nc bnc" id="L87" title="All 2 branches missed.">        } else if (&quot;/api/orders/status&quot;.equals(path)) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="nc" id="L89">                handleUpdateStatus(exchange);</span>
            } else {
<span class="nc" id="L91">                exchange.sendResponseHeaders(405, -1);</span>
            }
        } else {
<span class="nc" id="L94">            exchange.sendResponseHeaders(404, -1);</span>
        }
<span class="fc" id="L96">    }</span>

    private void handleApiListOrders(HttpExchange exchange) throws IOException {
<span class="fc" id="L99">        String query = exchange.getRequestURI().getQuery();</span>
<span class="fc" id="L100">        String customerName = null;</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (query != null) {</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">            for (String param : query.split(&quot;&amp;&quot;)) {</span>
<span class="fc" id="L103">                String[] pair = param.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L104" title="2 of 4 branches missed.">                if (pair.length == 2 &amp;&amp; &quot;customer&quot;.equals(pair[0])) {</span>
<span class="fc" id="L105">                    customerName = java.net.URLDecoder.decode(pair[1], StandardCharsets.UTF_8);</span>
                }
            }
        }

        try {
<span class="fc" id="L111">            List&lt;Order&gt; orders = repository.findAll(); // Should filter by customer in DB, but filtering in memory for now</span>
<span class="fc" id="L112">            List&lt;Order&gt; filteredOrders = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">            if (customerName != null) {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                for (Order o : orders) {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">                    if (customerName.equals(o.getCustomerName())) {</span>
<span class="fc" id="L116">                        filteredOrders.add(o);</span>
                    }
<span class="fc" id="L118">                }</span>
            } else {
<span class="nc" id="L120">                filteredOrders = orders;</span>
            }

<span class="fc" id="L123">            StringBuilder json = new StringBuilder(&quot;[&quot;);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            for (int i = 0; i &lt; filteredOrders.size(); i++) {</span>
<span class="fc" id="L125">                Order o = filteredOrders.get(i);</span>
<span class="fc" id="L126">                json.append(String.format(&quot;{\&quot;id\&quot;:%d,\&quot;customerName\&quot;:\&quot;%s\&quot;,\&quot;status\&quot;:\&quot;%s\&quot;,\&quot;pointsEarned\&quot;:%d,\&quot;pointsRedeemed\&quot;:%d}&quot;, </span>
<span class="fc" id="L127">                    o.getId(), o.getCustomerName(), o.getStatus(), o.getPointsEarned(), o.getPointsToRedeem()));</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">                if (i &lt; filteredOrders.size() - 1) {</span>
<span class="nc" id="L129">                    json.append(&quot;,&quot;);</span>
                }
            }
<span class="fc" id="L132">            json.append(&quot;]&quot;);</span>

<span class="fc" id="L134">            String response = json.toString();</span>
<span class="fc" id="L135">            byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L136">            exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L137">            exchange.sendResponseHeaders(200, bytes.length);</span>
<span class="fc" id="L138">            try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L139">                os.write(bytes);</span>
            }
<span class="nc" id="L141">        } catch (SQLException e) {</span>
<span class="nc" id="L142">            e.printStackTrace();</span>
<span class="nc" id="L143">            exchange.sendResponseHeaders(500, -1);</span>
<span class="fc" id="L144">        }</span>
<span class="fc" id="L145">    }</span>

    private void handleListOrders(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L149">            List&lt;Order&gt; orders = repository.findAll();</span>
<span class="nc" id="L150">            System.out.println(&quot;Listing &quot; + orders.size() + &quot; orders.&quot;); // Added logging</span>
            
<span class="nc" id="L152">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L153">            sb.append(&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot;).append(CSS).append(&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot;);</span>
<span class="nc" id="L154">            sb.append(getHeader());</span>
<span class="nc" id="L155">            sb.append(&quot;&lt;h1&gt;Order Management&lt;/h1&gt;&quot;);</span>
<span class="nc" id="L156">            sb.append(&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Customer&lt;/th&gt;&lt;th&gt;Status&lt;/th&gt;&lt;th&gt;Items&lt;/th&gt;&lt;th&gt;Points Earned&lt;/th&gt;&lt;th&gt;Actions&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
            
<span class="nc bnc" id="L158" title="All 2 branches missed.">            for (Order o : orders) {</span>
<span class="nc" id="L159">                System.out.println(&quot;Order: &quot; + o.getId() + &quot;, Status: &quot; + o.getStatus()); // Added logging</span>
<span class="nc" id="L160">                sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="nc" id="L161">                sb.append(&quot;&lt;td&gt;&quot;).append(o.getId()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L162">                sb.append(&quot;&lt;td&gt;&quot;).append(o.getCustomerName()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L163">                sb.append(&quot;&lt;td&gt;&quot;).append(o.getStatus()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L164">                sb.append(&quot;&lt;td&gt;&quot;).append(o.getItems().size()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L165">                sb.append(&quot;&lt;td&gt;&quot;).append(o.getPointsEarned()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L166">                sb.append(&quot;&lt;td&gt;&quot;);</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (&quot;PENDING_CONFIRMATION&quot;.equals(o.getStatus())) {</span>
<span class="nc" id="L168">                     sb.append(&quot;&lt;form action='/orders/confirm' method='post' style='display:inline;'&gt;&quot;);</span>
<span class="nc" id="L169">                     sb.append(&quot;&lt;input type='hidden' name='id' value='&quot;).append(o.getId()).append(&quot;'&gt;&quot;);</span>
<span class="nc" id="L170">                     sb.append(&quot;&lt;button type='submit' class='btn btn-success'&gt;Confirm&lt;/button&gt;&quot;);</span>
<span class="nc" id="L171">                     sb.append(&quot;&lt;/form&gt;&quot;);</span>
                }
<span class="nc" id="L173">                sb.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="nc" id="L174">                sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="nc" id="L175">            }</span>
<span class="nc" id="L176">            sb.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
            
<span class="nc" id="L178">            String response = sb.toString();</span>
<span class="nc" id="L179">            byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L180">            exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="nc" id="L181">            exchange.sendResponseHeaders(200, bytes.length);</span>
<span class="nc" id="L182">            try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L183">                os.write(bytes);</span>
            }
<span class="nc" id="L185">        } catch (SQLException e) {</span>
<span class="nc" id="L186">            e.printStackTrace();</span>
<span class="nc" id="L187">            exchange.sendResponseHeaders(500, -1);</span>
<span class="nc" id="L188">        }</span>
<span class="nc" id="L189">    }</span>

    private void handleCreateOrder(HttpExchange exchange) throws IOException {
<span class="fc" id="L192">        int orderId = -1;</span>
        try {
<span class="fc" id="L194">            InputStream is = exchange.getRequestBody();</span>
<span class="fc" id="L195">            String json = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L196">            System.out.println(&quot;Received Order: &quot; + json);</span>
            
<span class="fc" id="L198">            Order order = parseOrder(json);</span>
            
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (order.getItems().isEmpty()) {</span>
<span class="nc" id="L201">                System.out.println(&quot;Warning: No items found in order!&quot;);</span>
            }

            // Handle Point Redemption
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">            if (order.getPointsToRedeem() &gt; 0) {</span>
                // We need an order ID to redeem points against, but we haven't created the order yet.
                // Strategy says: &quot;Order Service calls Loyalty Service to redeem (deduct) the points.&quot;
                // &quot;If the order fails, the points must be refunded (Compensating Transaction).&quot;
                // For MVP, we can create the order first as PENDING, then redeem.
                // If redeem fails, we mark order as REJECTED (or FAILED_REDEMPTION).
            }

<span class="fc" id="L213">            order.setStatus(&quot;PENDING&quot;);</span>
<span class="fc" id="L214">            orderId = repository.createOrder(order);</span>
            
<span class="fc" id="L216">            boolean redemptionSuccess = true;</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (order.getPointsToRedeem() &gt; 0) {</span>
<span class="nc" id="L218">                redemptionSuccess = loyaltyService.redeemPoints(order.getCustomerName(), orderId, order.getPointsToRedeem()).join();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">                if (!redemptionSuccess) {</span>
<span class="nc" id="L220">                    System.out.println(&quot;Point redemption failed for order &quot; + orderId);</span>
<span class="nc" id="L221">                    repository.updateStatus(orderId, &quot;REDEMPTION_FAILED&quot;);</span>
<span class="nc" id="L222">                    String response = &quot;{\&quot;status\&quot;:\&quot;REDEMPTION_FAILED\&quot;, \&quot;orderId\&quot;:&quot; + orderId + &quot;}&quot;;</span>
<span class="nc" id="L223">                    byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L224">                    exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L225">                    exchange.sendResponseHeaders(409, bytes.length);</span>
<span class="nc" id="L226">                    try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L227">                        os.write(bytes);</span>
                    }
<span class="nc" id="L229">                    return;</span>
                }
            }

            // Reserve stock
<span class="fc" id="L234">            boolean allReserved = true;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">            for (OrderItem item : order.getItems()) {</span>
<span class="fc" id="L236">                boolean reserved = stockService.reserveStock(item.getProductId(), item.getQuantity()).join();</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                if (!reserved) {</span>
<span class="nc" id="L238">                    allReserved = false;</span>
<span class="nc" id="L239">                    break;</span>
                }
<span class="fc" id="L241">            }</span>
            
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            if (allReserved) {</span>
                // Changed from CONFIRMED to PENDING_CONFIRMATION to allow manual confirmation
<span class="fc" id="L245">                repository.updateStatus(orderId, &quot;PENDING_CONFIRMATION&quot;);</span>
                
                // Notification to Warehouse and Invoice creation is now moved to handleConfirmOrder

                // Return 201 and &quot;created&quot; to match Pact contract
<span class="fc" id="L250">                System.out.println(&quot;OrderController: Returning 201 Created&quot;);</span>
<span class="fc" id="L251">                String response = &quot;{\&quot;status\&quot;:\&quot;created\&quot;, \&quot;orderId\&quot;:&quot; + orderId + &quot;}&quot;;</span>
<span class="fc" id="L252">                byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L253">                exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="fc" id="L254">                exchange.sendResponseHeaders(201, bytes.length);</span>
<span class="fc" id="L255">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L256">                    os.write(bytes);</span>
                }
<span class="fc" id="L258">            } else {</span>
                // If stock reservation failed, we should refund points if they were redeemed.
                // For MVP, we log this.
<span class="nc bnc" id="L261" title="All 2 branches missed.">                if (order.getPointsToRedeem() &gt; 0) {</span>
<span class="nc" id="L262">                    System.err.println(&quot;CRITICAL: Stock reservation failed but points were redeemed for order &quot; + orderId + &quot;. Manual refund required.&quot;);</span>
                }

<span class="nc" id="L265">                repository.updateStatus(orderId, &quot;REJECTED&quot;);</span>
<span class="nc" id="L266">                String response = &quot;{\&quot;status\&quot;:\&quot;REJECTED\&quot;, \&quot;orderId\&quot;:&quot; + orderId + &quot;}&quot;;</span>
<span class="nc" id="L267">                byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L268">                exchange.sendResponseHeaders(409, bytes.length); // Conflict</span>
<span class="nc" id="L269">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L270">                    os.write(bytes);</span>
                }
            }
            
<span class="nc" id="L274">        } catch (Exception e) {</span>
<span class="nc" id="L275">            e.printStackTrace();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">            if (orderId != -1) {</span>
                try {
<span class="nc" id="L278">                    repository.updateStatus(orderId, &quot;ERROR&quot;);</span>
<span class="nc" id="L279">                } catch (SQLException ex) {</span>
<span class="nc" id="L280">                    e.addSuppressed(ex);</span>
<span class="nc" id="L281">                }</span>
            }
<span class="nc" id="L283">            exchange.sendResponseHeaders(500, -1);</span>
<span class="fc" id="L284">        }</span>
<span class="fc" id="L285">    }</span>

    private void handleConfirmOrder(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L289">            InputStream is = exchange.getRequestBody();</span>
<span class="nc" id="L290">            String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L291">            Map&lt;String, String&gt; params = parseFormData(formData);</span>
            
<span class="nc" id="L293">            int orderId = Integer.parseInt(params.get(&quot;id&quot;));</span>
            
<span class="nc" id="L295">            repository.updateStatus(orderId, &quot;CONFIRMED&quot;);</span>
            
            // Create Invoice (Moved from handleCreateOrder)
            // We need to fetch the order details to get customer name and calculate amount
            // For now, I'll assume we can get it or just use placeholders as per upstream logic
            // Upstream logic: invoiceRepository.createInvoice(new Invoice(orderId, order.getCustomerName(), totalAmount, LocalDate.now().plusDays(30)));
            // But we don't have 'order' object here.
            // Let's fetch it.
            // Assuming repository has findById.
            // If not, we might need to add it or use a simplified approach.
            // repository.findAll() exists.
            
            // Let's try to find the order from findAll (inefficient but works for now)
<span class="nc" id="L308">            List&lt;Order&gt; allOrders = repository.findAll();</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">            Order order = allOrders.stream().filter(o -&gt; o.getId() == orderId).findFirst().orElse(null);</span>
            
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (order != null) {</span>
<span class="nc" id="L312">                 double totalAmount = order.getTotalAmount();</span>
<span class="nc" id="L313">                 invoiceRepository.createInvoice(new Invoice(orderId, order.getCustomerName(), totalAmount, LocalDate.now().plusDays(30)));</span>
                 
                 // Accrue Points
                 // We need to calculate total amount properly or pass it.
                 // For now, assuming totalAmount is 0 (placeholder), but we should probably calculate it from items if we had prices.
                 // Or we can assume the frontend passed it, but Order object doesn't store totalAmount.
                 // Let's assume 100.0 for now or try to get it.
                 // Actually, LoyaltyIntegrationService needs itemsJson.
                 // We can reconstruct itemsJson from order.getItems().
                 
<span class="nc" id="L323">                 StringBuilder itemsJson = new StringBuilder(&quot;[&quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                 for (int i = 0; i &lt; order.getItems().size(); i++) {</span>
<span class="nc" id="L325">                     OrderItem item = order.getItems().get(i);</span>
<span class="nc" id="L326">                     itemsJson.append(String.format(&quot;{\&quot;productId\&quot;:\&quot;%d\&quot;,\&quot;quantity\&quot;:%d}&quot;, item.getProductId(), item.getQuantity()));</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                     if (i &lt; order.getItems().size() - 1) itemsJson.append(&quot;,&quot;);</span>
                 }
<span class="nc" id="L329">                 itemsJson.append(&quot;]&quot;);</span>
                 
<span class="nc" id="L331">                 int pointsEarned = loyaltyService.accruePoints(order.getCustomerName(), orderId, totalAmount, itemsJson.toString()).join();</span>
<span class="nc" id="L332">                 repository.updatePointsEarned(orderId, pointsEarned);</span>
<span class="nc" id="L333">            } else {</span>
<span class="nc" id="L334">                System.err.println(&quot;Order not found for invoice creation: &quot; + orderId);</span>
            }
            
            // Notify Warehouse for fulfillment
<span class="nc" id="L338">            boolean notified = fulfillmentService.notifyOrderConfirmed(orderId).join();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (!notified) {</span>
<span class="nc" id="L340">                System.err.println(&quot;Failed to notify warehouse for order &quot; + orderId);</span>
<span class="nc" id="L341">                repository.updateStatus(orderId, &quot;CONFIRMATION_FAILED&quot;);</span>
<span class="nc" id="L342">                throw new IOException(&quot;Failed to notify warehouse for fulfillment&quot;);</span>
            }

<span class="nc" id="L345">            exchange.getResponseHeaders().set(&quot;Location&quot;, &quot;/orders&quot;);</span>
<span class="nc" id="L346">            exchange.sendResponseHeaders(302, -1);</span>
<span class="nc" id="L347">        } catch (Exception e) {</span>
<span class="nc" id="L348">            e.printStackTrace();</span>
<span class="nc" id="L349">            exchange.sendResponseHeaders(500, -1);</span>
<span class="nc" id="L350">        }</span>
<span class="nc" id="L351">    }</span>

    private void handleUpdateStatus(HttpExchange exchange) throws IOException {
        try {
<span class="nc" id="L355">            InputStream is = exchange.getRequestBody();</span>
<span class="nc" id="L356">            String json = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L357">            System.out.println(&quot;Update Status Request: &quot; + json);</span>
            
<span class="nc" id="L359">            int orderId = -1;</span>
<span class="nc" id="L360">            String status = null;</span>
            
            // Simple JSON parsing
<span class="nc" id="L363">            Pattern pId = Pattern.compile(&quot;\&quot;orderId\&quot;\\s*:\\s*(\\d+)&quot;);</span>
<span class="nc" id="L364">            Matcher mId = pId.matcher(json);</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">            if (mId.find()) {</span>
<span class="nc" id="L366">                orderId = Integer.parseInt(mId.group(1));</span>
            }
            
<span class="nc" id="L369">            Pattern pStatus = Pattern.compile(&quot;\&quot;status\&quot;\\s*:\\s*\&quot;([^\&quot;]+)\&quot;&quot;);</span>
<span class="nc" id="L370">            Matcher mStatus = pStatus.matcher(json);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (mStatus.find()) {</span>
<span class="nc" id="L372">                status = mStatus.group(1);</span>
            }
            
<span class="nc bnc" id="L375" title="All 4 branches missed.">            if (orderId != -1 &amp;&amp; status != null) {</span>
<span class="nc" id="L376">                repository.updateStatus(orderId, status);</span>
<span class="nc" id="L377">                String response = &quot;{\&quot;status\&quot;:\&quot;updated\&quot;}&quot;;</span>
<span class="nc" id="L378">                byte[] bytes = response.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L379">                exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<span class="nc" id="L380">                exchange.sendResponseHeaders(200, bytes.length);</span>
<span class="nc" id="L381">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L382">                    os.write(bytes);</span>
                }
<span class="nc" id="L384">            } else {</span>
<span class="nc" id="L385">                exchange.sendResponseHeaders(400, -1);</span>
            }
<span class="nc" id="L387">        } catch (Exception e) {</span>
<span class="nc" id="L388">            e.printStackTrace();</span>
<span class="nc" id="L389">            exchange.sendResponseHeaders(500, -1);</span>
<span class="nc" id="L390">        }</span>
<span class="nc" id="L391">    }</span>

    private Order parseOrder(String json) {
<span class="fc" id="L394">        Order order = new Order();</span>
        
        // Extract customerName
<span class="fc" id="L397">        Pattern customerNamePattern = Pattern.compile(&quot;\&quot;customerName\&quot;\\s*:\\s*\&quot;([^\&quot;]+)\&quot;&quot;);</span>
<span class="fc" id="L398">        Matcher customerNameMatcher = customerNamePattern.matcher(json);</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">        if (customerNameMatcher.find()) {</span>
<span class="fc" id="L400">            order.setCustomerName(customerNameMatcher.group(1));</span>
        } else {
<span class="nc" id="L402">            order.setCustomerName(&quot;Unknown Customer&quot;); // Default</span>
        }
        
        // Extract pointsToRedeem
<span class="fc" id="L406">        Pattern pointsPattern = Pattern.compile(&quot;\&quot;pointsToRedeem\&quot;\\s*:\\s*(\\d+)&quot;);</span>
<span class="fc" id="L407">        Matcher pointsMatcher = pointsPattern.matcher(json);</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">        if (pointsMatcher.find()) {</span>
<span class="nc" id="L409">            order.setPointsToRedeem(Integer.parseInt(pointsMatcher.group(1)));</span>
        }

        // Extract totalAmount
<span class="fc" id="L413">        Pattern totalAmountPattern = Pattern.compile(&quot;\&quot;totalAmount\&quot;\\s*:\\s*([\\d.]+)&quot;);</span>
<span class="fc" id="L414">        Matcher totalAmountMatcher = totalAmountPattern.matcher(json);</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">        if (totalAmountMatcher.find()) {</span>
<span class="nc" id="L416">            order.setTotalAmount(Double.parseDouble(totalAmountMatcher.group(1)));</span>
        }

        // Extract items - robust parsing
        // Split by &quot;}&quot; to separate objects roughly
<span class="fc" id="L421">        String[] parts = json.split(&quot;\\}&quot;);</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">        for (String part : parts) {</span>
<span class="pc bpc" id="L423" title="1 of 4 branches missed.">            if (part.contains(&quot;productId&quot;) &amp;&amp; part.contains(&quot;quantity&quot;)) {</span>
<span class="fc" id="L424">                int productId = -1;</span>
<span class="fc" id="L425">                int quantity = -1;</span>
                
<span class="fc" id="L427">                Pattern pId = Pattern.compile(&quot;\&quot;productId\&quot;\\s*:\\s*(\\d+)&quot;);</span>
<span class="fc" id="L428">                Matcher mId = pId.matcher(part);</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">                if (mId.find()) {</span>
<span class="fc" id="L430">                    productId = Integer.parseInt(mId.group(1));</span>
                }
                
<span class="fc" id="L433">                Pattern pQty = Pattern.compile(&quot;\&quot;quantity\&quot;\\s*:\\s*(\\d+)&quot;);</span>
<span class="fc" id="L434">                Matcher mQty = pQty.matcher(part);</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">                if (mQty.find()) {</span>
<span class="fc" id="L436">                    quantity = Integer.parseInt(mQty.group(1));</span>
                }
                
<span class="pc bpc" id="L439" title="2 of 4 branches missed.">                if (productId != -1 &amp;&amp; quantity != -1) {</span>
<span class="fc" id="L440">                    order.addItem(new OrderItem(productId, quantity));</span>
                }
            }
        }

<span class="fc" id="L445">        return order;</span>
    }

    private void sendError(HttpExchange exchange, int code, String message) throws IOException {
<span class="nc" id="L449">        byte[] bytes = message.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L450">        exchange.sendResponseHeaders(code, bytes.length);</span>
<span class="nc" id="L451">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L452">            os.write(bytes);</span>
        }
<span class="nc" id="L454">    }</span>

    private Map&lt;String, String&gt; parseFormData(String formData) {
<span class="nc" id="L457">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc" id="L458">        String[] pairs = formData.split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        for (String pair : pairs) {</span>
<span class="nc" id="L460">            String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if (keyValue.length &gt; 0) {</span>
<span class="nc" id="L462">                String key = java.net.URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                String value = keyValue.length &gt; 1 ? java.net.URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8) : &quot;&quot;;</span>
<span class="nc" id="L464">                map.put(key, value);</span>
            }
        }
<span class="nc" id="L467">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>