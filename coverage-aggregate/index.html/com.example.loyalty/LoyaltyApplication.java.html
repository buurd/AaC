<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoyaltyApplication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.loyalty</a> &gt; <span class="el_source">LoyaltyApplication.java</span></div><h1>LoyaltyApplication.java</h1><pre class="source lang-java linenums">package com.example.loyalty;

import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.URI;
import java.net.URLDecoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;

<span class="nc" id="L21">public class LoyaltyApplication {</span>

    public static void main(String[] args) throws IOException {
<span class="nc" id="L24">        int port = 8084;</span>
<span class="nc" id="L25">        HttpServer server = HttpServer.create(new InetSocketAddress(port), 0);</span>

        // Database Configuration (Environment Variables)
<span class="nc" id="L28">        String dbUrl = System.getenv().getOrDefault(&quot;DB_URL&quot;, &quot;jdbc:postgresql://localhost:5432/loyalty_db&quot;);</span>
<span class="nc" id="L29">        String dbUser = System.getenv().getOrDefault(&quot;DB_USER&quot;, &quot;postgres&quot;);</span>
<span class="nc" id="L30">        String dbPassword = System.getenv().getOrDefault(&quot;DB_PASSWORD&quot;, &quot;postgres&quot;);</span>

        // Security Configuration
<span class="nc" id="L33">        String jwksUrl = System.getenv().getOrDefault(&quot;JWKS_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/certs&quot;);</span>
<span class="nc" id="L34">        String issuer = System.getenv().getOrDefault(&quot;ISSUER_URL&quot;, &quot;https://localhost:8446/realms/webshop-realm&quot;);</span>
<span class="nc" id="L35">        String tokenUrl = System.getenv().getOrDefault(&quot;TOKEN_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/token&quot;);</span>

        // Dependency Injection
<span class="nc" id="L38">        LoyaltyRepository repository = new LoyaltyRepository(dbUrl, dbUser, dbPassword);</span>
<span class="nc" id="L39">        BonusRuleEngine ruleEngine = new BonusRuleEngine();</span>
<span class="nc" id="L40">        PointService pointService = new PointService(repository, ruleEngine);</span>
<span class="nc" id="L41">        LoyaltyController controller = new LoyaltyController(pointService, ruleEngine);</span>

        // Security Filter for admin actions
<span class="nc" id="L44">        SecurityFilter adminFilter = new SecurityFilter(jwksUrl, issuer, &quot;loyalty-manager&quot;);</span>

        // Public routes
<span class="nc" id="L47">        server.createContext(&quot;/api/loyalty/balance/&quot;, controller);</span>
<span class="nc" id="L48">        server.createContext(&quot;/api/loyalty/rules&quot;, controller);</span>
<span class="nc" id="L49">        server.createContext(&quot;/api/loyalty/calculate&quot;, controller);</span>
<span class="nc" id="L50">        server.createContext(&quot;/api/loyalty/accrue&quot;, controller);</span>
<span class="nc" id="L51">        server.createContext(&quot;/api/loyalty/redeem&quot;, controller);</span>
<span class="nc" id="L52">        server.createContext(&quot;/&quot;, controller);</span>
        
        // Protected admin routes
<span class="nc" id="L55">        HttpContext adminContext = server.createContext(&quot;/api/loyalty/admin/&quot;, controller);</span>
<span class="nc" id="L56">        adminContext.getFilters().add(adminFilter);</span>
        
<span class="nc" id="L58">        HttpContext dashboardContext = server.createContext(&quot;/admin/dashboard&quot;, controller);</span>
<span class="nc" id="L59">        dashboardContext.getFilters().add(adminFilter);</span>

<span class="nc" id="L61">        server.createContext(&quot;/login&quot;, new LoginHandler(tokenUrl));</span>

<span class="nc" id="L63">        server.setExecutor(null); // creates a default executor</span>
<span class="nc" id="L64">        server.start();</span>
<span class="nc" id="L65">        System.out.println(&quot;Loyalty Service started on port &quot; + port);</span>
<span class="nc" id="L66">    }</span>

    static class LoginHandler implements HttpHandler {
        private final String tokenUrl;
        private final HttpClient httpClient;

        public LoginHandler(String tokenUrl) {
<span class="nc" id="L73">            this(tokenUrl, HttpClient.newBuilder().connectTimeout(Duration.ofSeconds(5)).build());</span>
<span class="nc" id="L74">        }</span>

<span class="fc" id="L76">        public LoginHandler(String tokenUrl, HttpClient httpClient) {</span>
<span class="fc" id="L77">            this.tokenUrl = tokenUrl;</span>
<span class="fc" id="L78">            this.httpClient = httpClient;</span>
<span class="fc" id="L79">        }</span>

        @Override
        public void handle(HttpExchange t) throws IOException {
<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (&quot;POST&quot;.equalsIgnoreCase(t.getRequestMethod())) {</span>
<span class="fc" id="L84">                InputStream is = t.getRequestBody();</span>
<span class="fc" id="L85">                String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L86">                Map&lt;String, String&gt; params = parseFormData(formData);</span>
                
<span class="fc" id="L88">                String username = params.get(&quot;username&quot;);</span>
<span class="fc" id="L89">                String password = params.get(&quot;password&quot;);</span>
                
<span class="fc" id="L91">                String requestBody = &quot;client_id=webshop-client&amp;grant_type=password&amp;username=&quot; + username + &quot;&amp;password=&quot; + password;</span>
                
<span class="fc" id="L93">                HttpRequest request = HttpRequest.newBuilder()</span>
<span class="fc" id="L94">                        .uri(URI.create(tokenUrl))</span>
<span class="fc" id="L95">                        .header(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;)</span>
<span class="fc" id="L96">                        .POST(HttpRequest.BodyPublishers.ofString(requestBody))</span>
<span class="fc" id="L97">                        .build();</span>
                
                try {
<span class="fc" id="L100">                    HttpResponse&lt;String&gt; response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">                    if (response.statusCode() == 200) {</span>
<span class="fc" id="L102">                        String json = response.body();</span>
<span class="fc" id="L103">                        String accessToken = extractToken(json);</span>
<span class="fc" id="L104">                        t.getResponseHeaders().add(&quot;Set-Cookie&quot;, &quot;auth_token=&quot; + accessToken + &quot;; Path=/; HttpOnly&quot;);</span>
<span class="fc" id="L105">                        redirect(t, &quot;/admin/dashboard&quot;);</span>
<span class="fc" id="L106">                    } else {</span>
<span class="fc" id="L107">                        sendResponse(t, 401, &quot;&lt;h1&gt;Login Failed&lt;/h1&gt;&lt;p&gt;Invalid credentials&lt;/p&gt;&lt;a href='/login'&gt;Try Again&lt;/a&gt;&quot;);</span>
                    }
<span class="fc" id="L109">                } catch (InterruptedException e) {</span>
<span class="fc" id="L110">                    sendResponse(t, 500, &quot;&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;&quot; + e.getMessage() + &quot;&lt;/p&gt;&quot;);</span>
<span class="fc" id="L111">                }</span>
<span class="fc" id="L112">            } else {</span>
<span class="fc" id="L113">                String body = &quot;&lt;h1&gt;Login&lt;/h1&gt;&quot; +</span>
                              &quot;&lt;form action='/login' method='post'&gt;&quot; +
                              &quot;&lt;label&gt;Username&lt;/label&gt;&lt;input type='text' name='username'&gt;&quot; +
                              &quot;&lt;label&gt;Password&lt;/label&gt;&lt;input type='password' name='password'&gt;&quot; +
                              &quot;&lt;button type='submit'&gt;Login&lt;/button&gt;&quot; +
                              &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L119">                sendResponse(t, 200, body);</span>
            }
<span class="fc" id="L121">        }</span>

        private String extractToken(String json) {
<span class="fc" id="L124">            int start = json.indexOf(&quot;\&quot;access_token\&quot;:\&quot;&quot;);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">            if (start == -1) return null;</span>
<span class="fc" id="L126">            start += 16;</span>
<span class="fc" id="L127">            int end = json.indexOf(&quot;\&quot;&quot;, start);</span>
<span class="fc" id="L128">            return json.substring(start, end);</span>
        }

        private void sendResponse(HttpExchange t, int status, String body) throws IOException {
<span class="fc" id="L132">            byte[] bytes = body.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L133">            t.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="fc" id="L134">            t.sendResponseHeaders(status, bytes.length);</span>
<span class="fc" id="L135">            try (OutputStream os = t.getResponseBody()) {</span>
<span class="fc" id="L136">                os.write(bytes);</span>
            }
<span class="fc" id="L138">        }</span>

        private void redirect(HttpExchange t, String location) throws IOException {
<span class="fc" id="L141">            t.getResponseHeaders().set(&quot;Location&quot;, location);</span>
<span class="fc" id="L142">            t.sendResponseHeaders(302, -1);</span>
<span class="fc" id="L143">        }</span>

        private Map&lt;String, String&gt; parseFormData(String formData) {
<span class="fc" id="L146">            Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L147">            String[] pairs = formData.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">            for (String pair : pairs) {</span>
<span class="fc" id="L149">                String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                if (keyValue.length &gt; 0) {</span>
<span class="fc" id="L151">                    String key = URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                    String value = keyValue.length &gt; 1 ? URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8) : &quot;&quot;;</span>
<span class="fc" id="L153">                    map.put(key, value);</span>
                }
            }
<span class="fc" id="L156">            return map;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>