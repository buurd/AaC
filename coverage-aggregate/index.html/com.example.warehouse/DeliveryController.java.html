<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeliveryController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.warehouse</a> &gt; <span class="el_source">DeliveryController.java</span></div><h1>DeliveryController.java</h1><pre class="source lang-java linenums">package com.example.warehouse;

import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import java.io.IOException;
import java.io.OutputStream;
import java.io.InputStream;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class DeliveryController implements HttpHandler {

    private final DeliveryRepository deliveryRepository;
    private final ProductRepository productRepository;
    private final StockService stockService;

<span class="fc" id="L22">    public DeliveryController(DeliveryRepository deliveryRepository, ProductRepository productRepository, StockService stockService) {</span>
<span class="fc" id="L23">        this.deliveryRepository = deliveryRepository;</span>
<span class="fc" id="L24">        this.productRepository = productRepository;</span>
<span class="fc" id="L25">        this.stockService = stockService;</span>
<span class="fc" id="L26">    }</span>

    private static final String CSS = 
        &quot;body { font-family: Arial, Helvetica, sans-serif; background-color: #F8F9FA; color: #343A40; margin: 0; padding: 20px; }&quot; +
        &quot;.container { max-width: 1200px; margin: 0 auto; background-color: #FFFFFF; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }&quot; +
        &quot;h1, h2 { color: #343A40; }&quot; +
        &quot;table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }&quot; +
        &quot;th { background-color: #007BFF; color: #FFFFFF; padding: 12px; text-align: left; }&quot; +
        &quot;td { padding: 12px; border-bottom: 1px solid #DEE2E6; }&quot; +
        &quot;tr:nth-child(even) { background-color: #F2F2F2; }&quot; +
        &quot;.btn { display: inline-block; padding: 10px 20px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; border: none; cursor: pointer; margin-right: 5px; }&quot; +
        &quot;.btn-primary { background-color: #007BFF; }&quot; +
        &quot;.btn-secondary { background-color: #6C757D; }&quot; +
        &quot;.btn-danger { background-color: #DC3545; }&quot; +
        &quot;.btn-success { background-color: #28A745; }&quot; +
        &quot;input[type='text'], select { padding: 8px; border: 1px solid #CED4DA; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }&quot; +
        &quot;label { display: block; font-weight: bold; margin-bottom: 5px; }&quot;;

    private String getHeader() {
<span class="fc" id="L45">        return &quot;&lt;div style='display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;'&gt;&quot; +</span>
               &quot;&lt;button onclick=\&quot;window.location.href='/'\&quot; class='btn btn-primary'&gt;Warehouse Dashboard&lt;/button&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/logout'\&quot; class='btn btn-secondary'&gt;Logout&lt;/button&gt;&quot; +
               &quot;&lt;/div&gt;&quot;;
    }

    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L53">        String path = exchange.getRequestURI().getPath();</span>
<span class="fc" id="L54">        String method = exchange.getRequestMethod();</span>

<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (path.equals(&quot;/deliveries&quot;)) {</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L58">                handleCreateDelivery(exchange);</span>
            } else {
<span class="fc" id="L60">                handleListDeliveries(exchange);</span>
            }
<span class="fc bfc" id="L62" title="All 2 branches covered.">        } else if (path.equals(&quot;/deliveries/view&quot;)) {</span>
<span class="fc" id="L63">            handleViewDelivery(exchange);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        } else if (path.equals(&quot;/deliveries/add-item&quot;)) {</span>
<span class="fc" id="L65">            handleAddItem(exchange);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        } else if (path.equals(&quot;/deliveries/return&quot;)) {</span>
<span class="fc" id="L67">            handleReturnDelivery(exchange);</span>
        } else {
<span class="fc" id="L69">            exchange.sendResponseHeaders(404, -1);</span>
        }
<span class="fc" id="L71">    }</span>

    private void handleListDeliveries(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L75">            List&lt;Delivery&gt; deliveries = deliveryRepository.findAll();</span>
<span class="fc" id="L76">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L77">            sb.append(&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot;).append(CSS).append(&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot;);</span>
<span class="fc" id="L78">            sb.append(getHeader());</span>
<span class="fc" id="L79">            sb.append(&quot;&lt;h1&gt;Deliveries&lt;/h1&gt;&quot;);</span>
<span class="fc" id="L80">            sb.append(&quot;&lt;form action='/deliveries' method='post' style='margin-bottom: 20px; border: 1px solid #ddd; padding: 10px;'&gt;&quot;);</span>
<span class="fc" id="L81">            sb.append(&quot;&lt;h3&gt;New Delivery&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L82">            sb.append(&quot;&lt;label&gt;Sender&lt;/label&gt;&lt;input type='text' name='sender' required&gt;&quot;);</span>
<span class="fc" id="L83">            sb.append(&quot;&lt;button type='submit' class='btn btn-success'&gt;Create Delivery&lt;/button&gt;&quot;);</span>
<span class="fc" id="L84">            sb.append(&quot;&lt;/form&gt;&quot;);</span>
            
<span class="fc" id="L86">            sb.append(&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Sender&lt;/th&gt;&lt;th&gt;Items&lt;/th&gt;&lt;th&gt;Actions&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            for (Delivery d : deliveries) {</span>
<span class="fc" id="L88">                sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L89">                sb.append(&quot;&lt;td&gt;&quot;).append(d.getId()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L90">                sb.append(&quot;&lt;td&gt;&quot;).append(d.getSender()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L91">                sb.append(&quot;&lt;td&gt;&quot;).append(d.getIndividuals().size()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L92">                sb.append(&quot;&lt;td&gt;&quot;);</span>
<span class="fc" id="L93">                sb.append(&quot;&lt;button onclick=\&quot;window.location.href='/deliveries/view?id=&quot;).append(d.getId()).append(&quot;'\&quot; class='btn btn-primary'&gt;View&lt;/button&gt;&quot;);</span>
<span class="fc" id="L94">                sb.append(&quot;&lt;form action='/deliveries/return' method='post' style='display:inline;'&gt;&quot;);</span>
<span class="fc" id="L95">                sb.append(&quot;&lt;input type='hidden' name='id' value='&quot;).append(d.getId()).append(&quot;'&gt;&quot;);</span>
<span class="fc" id="L96">                sb.append(&quot;&lt;button type='submit' class='btn btn-danger'&gt;Return&lt;/button&gt;&quot;);</span>
<span class="fc" id="L97">                sb.append(&quot;&lt;/form&gt;&quot;);</span>
<span class="fc" id="L98">                sb.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L99">                sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L100">            }</span>
<span class="fc" id="L101">            sb.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&quot;);</span>
<span class="fc" id="L102">            sb.append(&quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-secondary'&gt;Back to Products&lt;/button&gt;&quot;);</span>
<span class="fc" id="L103">            sb.append(&quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L104">            sendResponse(exchange, 200, sb.toString());</span>
<span class="nc" id="L105">        } catch (SQLException e) {</span>
<span class="nc" id="L106">            e.printStackTrace();</span>
<span class="nc" id="L107">            sendResponse(exchange, 500, &quot;Error: &quot; + e.getMessage());</span>
<span class="fc" id="L108">        }</span>
<span class="fc" id="L109">    }</span>

    private void handleCreateDelivery(HttpExchange exchange) throws IOException {
<span class="fc" id="L112">        Map&lt;String, String&gt; params = parseBody(exchange);</span>
        try {
<span class="fc" id="L114">            deliveryRepository.createDelivery(params.get(&quot;sender&quot;));</span>
<span class="fc" id="L115">            redirect(exchange, &quot;/deliveries&quot;);</span>
<span class="nc" id="L116">        } catch (SQLException e) {</span>
<span class="nc" id="L117">            e.printStackTrace();</span>
<span class="nc" id="L118">            sendResponse(exchange, 500, &quot;Error: &quot; + e.getMessage());</span>
<span class="fc" id="L119">        }</span>
<span class="fc" id="L120">    }</span>

    private void handleViewDelivery(HttpExchange exchange) throws IOException {
<span class="fc" id="L123">        String query = exchange.getRequestURI().getQuery();</span>
<span class="fc" id="L124">        Map&lt;String, String&gt; params = parseQuery(query);</span>
<span class="fc" id="L125">        int id = Integer.parseInt(params.get(&quot;id&quot;));</span>

        try {
<span class="fc" id="L128">            Delivery d = deliveryRepository.findById(id);</span>
<span class="fc" id="L129">            List&lt;Product&gt; products = productRepository.findAll();</span>

<span class="fc" id="L131">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L132">            sb.append(&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot;).append(CSS).append(&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot;);</span>
<span class="fc" id="L133">            sb.append(getHeader());</span>
<span class="fc" id="L134">            sb.append(&quot;&lt;h1&gt;Delivery #&quot;).append(d.getId()).append(&quot;&lt;/h1&gt;&quot;);</span>
<span class="fc" id="L135">            sb.append(&quot;&lt;p&gt;&lt;strong&gt;Sender:&lt;/strong&gt; &quot;).append(d.getSender()).append(&quot;&lt;/p&gt;&quot;);</span>
            
<span class="fc" id="L137">            sb.append(&quot;&lt;h3&gt;Add Item&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L138">            sb.append(&quot;&lt;form action='/deliveries/add-item' method='post' style='margin-bottom: 20px; border: 1px solid #ddd; padding: 10px;'&gt;&quot;);</span>
<span class="fc" id="L139">            sb.append(&quot;&lt;input type='hidden' name='deliveryId' value='&quot;).append(d.getId()).append(&quot;'&gt;&quot;);</span>
<span class="fc" id="L140">            sb.append(&quot;&lt;label&gt;Product&lt;/label&gt;&lt;select name='productId'&gt;&quot;);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">            for (Product p : products) {</span>
                // Display the product name which now includes variant info (e.g. &quot;T-Shirt - Red M&quot;)
<span class="nc" id="L143">                sb.append(&quot;&lt;option value='&quot;).append(p.getId()).append(&quot;'&gt;&quot;).append(p.getName()).append(&quot;&lt;/option&gt;&quot;);</span>
<span class="nc" id="L144">            }</span>
<span class="fc" id="L145">            sb.append(&quot;&lt;/select&gt;&quot;);</span>
<span class="fc" id="L146">            sb.append(&quot;&lt;label&gt;Serial Number&lt;/label&gt;&lt;input type='text' name='serialNumber' required&gt;&quot;);</span>
<span class="fc" id="L147">            sb.append(&quot;&lt;label&gt;State&lt;/label&gt;&lt;select name='state'&gt;&lt;option&gt;New&lt;/option&gt;&lt;option&gt;Damaged&lt;/option&gt;&lt;/select&gt;&quot;);</span>
<span class="fc" id="L148">            sb.append(&quot;&lt;button type='submit' class='btn btn-primary'&gt;Add Item&lt;/button&gt;&quot;);</span>
<span class="fc" id="L149">            sb.append(&quot;&lt;/form&gt;&quot;);</span>

<span class="fc" id="L151">            sb.append(&quot;&lt;h3&gt;Items&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L152">            sb.append(&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Product&lt;/th&gt;&lt;th&gt;Serial Number&lt;/th&gt;&lt;th&gt;State&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">            for (ProductIndividual item : d.getIndividuals()) {</span>
<span class="fc" id="L154">                Product p = productRepository.findById(item.getProductId());</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">                String productName = (p != null) ? p.getName() : &quot;Unknown Product (&quot; + item.getProductId() + &quot;)&quot;;</span>
                
<span class="fc" id="L157">                sb.append(&quot;&lt;tr&gt;&quot;);</span>
                // REQ-073: Display variant name
<span class="fc" id="L159">                sb.append(&quot;&lt;td&gt;&quot;).append(productName).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L160">                sb.append(&quot;&lt;td&gt;&quot;).append(item.getSerialNumber()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L161">                sb.append(&quot;&lt;td&gt;&quot;).append(item.getState()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L162">                sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L163">            }</span>
<span class="fc" id="L164">            sb.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&quot;);</span>
<span class="fc" id="L165">            sb.append(&quot;&lt;button onclick=\&quot;window.location.href='/deliveries'\&quot; class='btn btn-secondary'&gt;Back to Deliveries&lt;/button&gt;&quot;);</span>
<span class="fc" id="L166">            sb.append(&quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L167">            sendResponse(exchange, 200, sb.toString());</span>
<span class="nc" id="L168">        } catch (SQLException e) {</span>
<span class="nc" id="L169">            e.printStackTrace();</span>
<span class="nc" id="L170">            sendResponse(exchange, 500, &quot;Error: &quot; + e.getMessage());</span>
<span class="fc" id="L171">        }</span>
<span class="fc" id="L172">    }</span>

    private void handleAddItem(HttpExchange exchange) throws IOException {
<span class="fc" id="L175">        Map&lt;String, String&gt; params = parseBody(exchange);</span>
        try {
<span class="fc" id="L177">            ProductIndividual item = new ProductIndividual();</span>
<span class="fc" id="L178">            item.setDeliveryId(Integer.parseInt(params.get(&quot;deliveryId&quot;)));</span>
<span class="fc" id="L179">            item.setProductId(Integer.parseInt(params.get(&quot;productId&quot;)));</span>
<span class="fc" id="L180">            item.setSerialNumber(params.get(&quot;serialNumber&quot;));</span>
<span class="fc" id="L181">            item.setState(params.get(&quot;state&quot;));</span>
            
<span class="fc" id="L183">            deliveryRepository.addIndividual(item);</span>
            
            // Sync stock to Webshop
<span class="fc" id="L186">            int stock = deliveryRepository.countStock(item.getProductId());</span>
<span class="fc" id="L187">            Product p = productRepository.findById(item.getProductId());</span>
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">            if (p != null &amp;&amp; p.getPmId() != null) {</span>
<span class="fc" id="L189">                stockService.syncStock(p.getPmId(), stock);</span>
            }
            
<span class="fc" id="L192">            redirect(exchange, &quot;/deliveries/view?id=&quot; + item.getDeliveryId());</span>
<span class="nc" id="L193">        } catch (SQLException e) {</span>
<span class="nc" id="L194">            e.printStackTrace();</span>
<span class="nc" id="L195">            sendResponse(exchange, 500, &quot;Error: &quot; + e.getMessage());</span>
<span class="fc" id="L196">        }</span>
<span class="fc" id="L197">    }</span>

    private void handleReturnDelivery(HttpExchange exchange) throws IOException {
<span class="fc" id="L200">        Map&lt;String, String&gt; params = parseBody(exchange);</span>
        try {
<span class="fc" id="L202">            int id = Integer.parseInt(params.get(&quot;id&quot;));</span>
<span class="fc" id="L203">            deliveryRepository.deleteDelivery(id);</span>
            // TODO: Sync stock decrease? 
            // If we delete delivery, items are deleted (CASCADE).
            // We should recalculate stock for all affected products.
            // But we don't know which products were in the delivery easily without querying first.
            // For now, let's skip stock sync on return for simplicity, or implement it if critical.
            // Requirement REQ-042 says &quot;when inventory changes&quot;.
            // I'll leave it for now as it requires more complex logic (fetch items before delete).

<span class="fc" id="L212">            redirect(exchange, &quot;/deliveries&quot;);</span>
<span class="nc" id="L213">        } catch (SQLException e) {</span>
<span class="nc" id="L214">            e.printStackTrace();</span>
<span class="nc" id="L215">            sendResponse(exchange, 500, &quot;Error: &quot; + e.getMessage());</span>
<span class="fc" id="L216">        }</span>
<span class="fc" id="L217">    }</span>

    private void sendResponse(HttpExchange t, int status, String body) throws IOException {
<span class="fc" id="L220">        byte[] bytes = body.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L221">        t.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="fc" id="L222">        t.sendResponseHeaders(status, bytes.length);</span>
<span class="fc" id="L223">        try (OutputStream os = t.getResponseBody()) {</span>
<span class="fc" id="L224">            os.write(bytes);</span>
        }
<span class="fc" id="L226">    }</span>

    private void redirect(HttpExchange t, String location) throws IOException {
<span class="fc" id="L229">        t.getResponseHeaders().set(&quot;Location&quot;, location);</span>
<span class="fc" id="L230">        t.sendResponseHeaders(302, -1);</span>
<span class="fc" id="L231">    }</span>

    private Map&lt;String, String&gt; parseBody(HttpExchange t) throws IOException {
<span class="fc" id="L234">        InputStream is = t.getRequestBody();</span>
<span class="fc" id="L235">        String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L236">        return parseQuery(formData);</span>
    }

    private Map&lt;String, String&gt; parseQuery(String query) {
<span class="fc" id="L240">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L241" title="2 of 4 branches missed.">        if (query == null || query.isEmpty()) return map;</span>
<span class="fc" id="L242">        String[] pairs = query.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">        for (String pair : pairs) {</span>
<span class="fc" id="L244">            String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">            if (keyValue.length &gt; 0) {</span>
<span class="fc" id="L246">                String key = URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">                String value = keyValue.length &gt; 1 ? URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8) : &quot;&quot;;</span>
<span class="fc" id="L248">                map.put(key, value);</span>
            }
        }
<span class="fc" id="L251">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>