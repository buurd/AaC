<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WarehouseApplication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.warehouse</a> &gt; <span class="el_source">WarehouseApplication.java</span></div><h1>WarehouseApplication.java</h1><pre class="source lang-java linenums">package com.example.warehouse;

import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpContext;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.URI;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.Executors;

<span class="nc" id="L30">public class WarehouseApplication {</span>

<span class="fc" id="L32">    private static final Logger logger = LoggerFactory.getLogger(WarehouseApplication.class);</span>

    private static final String CSS = 
        &quot;body { font-family: Arial, Helvetica, sans-serif; background-color: #F8F9FA; color: #343A40; margin: 0; padding: 20px; }&quot; +
        &quot;.container { max-width: 1200px; margin: 0 auto; background-color: #FFFFFF; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }&quot; +
        &quot;h1 { color: #343A40; }&quot; +
        &quot;.btn { display: inline-block; padding: 10px 20px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; }&quot; +
        &quot;.btn-primary { background-color: #007BFF; }&quot; +
        &quot;.btn-secondary { background-color: #6C757D; }&quot; +
        &quot;input[type='text'], input[type='password'] { padding: 8px; border: 1px solid #CED4DA; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }&quot; +
        &quot;label { display: block; font-weight: bold; margin-bottom: 5px; }&quot;;

    public static void main(String[] args) throws IOException, SQLException {
        // --- Database Setup ---
<span class="nc" id="L46">        String dbUrl = System.getenv().getOrDefault(&quot;DB_URL&quot;, &quot;jdbc:postgresql://localhost:5434/postgres&quot;);</span>
<span class="nc" id="L47">        String dbUser = System.getenv().getOrDefault(&quot;DB_USER&quot;, &quot;postgres&quot;);</span>
<span class="nc" id="L48">        String dbPassword = System.getenv().getOrDefault(&quot;DB_PASSWORD&quot;, &quot;postgres&quot;);</span>

        // Security Setup
<span class="nc" id="L51">        String jwksUrl = System.getenv().getOrDefault(&quot;JWKS_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/certs&quot;);</span>
<span class="nc" id="L52">        String issuer = System.getenv().getOrDefault(&quot;ISSUER_URL&quot;, &quot;https://localhost:8446/realms/webshop-realm&quot;);</span>
<span class="nc" id="L53">        String tokenUrl = System.getenv().getOrDefault(&quot;TOKEN_URL&quot;, &quot;http://keycloak:8080/realms/webshop-realm/protocol/openid-connect/token&quot;);</span>
<span class="nc" id="L54">        String defaultKeycloakUrl = System.getenv().getOrDefault(&quot;KEYCLOAK_URL&quot;, &quot;https://localhost:8446&quot;);</span>

<span class="nc" id="L56">        logger.info(&quot;Connecting to database at: {}&quot;, dbUrl);</span>
<span class="nc" id="L57">        Connection connection = DriverManager.getConnection(dbUrl, dbUser, dbPassword);</span>
<span class="nc" id="L58">        logger.info(&quot;Database connection successful.&quot;);</span>

        // Initialize schema
<span class="nc" id="L61">        try (InputStream is = WarehouseApplication.class.getResourceAsStream(&quot;/schema.sql&quot;)) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L63">                throw new IOException(&quot;Cannot find schema.sql in resources.&quot;);</span>
            }
<span class="nc" id="L65">            String schemaSql = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L66">            try (Statement stmt = connection.createStatement()) {</span>
<span class="nc" id="L67">                stmt.execute(schemaSql);</span>
<span class="nc" id="L68">                logger.info(&quot;Database schema initialized.&quot;);</span>
            }
        }

<span class="nc" id="L72">        ProductRepository productRepository = new ProductRepository(connection);</span>
<span class="nc" id="L73">        DeliveryRepository deliveryRepository = new DeliveryRepository(connection);</span>
<span class="nc" id="L74">        FulfillmentOrderRepository fulfillmentOrderRepository = new FulfillmentOrderRepository(connection);</span>
        
        // Stock Service (Client to Webshop)
<span class="nc" id="L77">        StockService stockService = new StockService(</span>
<span class="nc" id="L78">            System.getenv().getOrDefault(&quot;WEBSHOP_STOCK_API_URL&quot;, &quot;http://webshop-demo:8000/api/stock/sync&quot;),</span>
            new KeycloakTokenService(
                tokenUrl,
<span class="nc" id="L81">                System.getenv().getOrDefault(&quot;CLIENT_ID&quot;, &quot;warehouse-client&quot;),</span>
<span class="nc" id="L82">                System.getenv().getOrDefault(&quot;CLIENT_SECRET&quot;, &quot;warehouse-secret&quot;)</span>
            )
        );
        
        // Order Update Service (Client to Order Service)
<span class="nc" id="L87">        OrderUpdateService orderUpdateService = new OrderUpdateService();</span>

<span class="nc" id="L89">        SecurityFilter staffFilter = new SecurityFilter(jwksUrl, issuer, &quot;warehouse-staff&quot;);</span>
<span class="nc" id="L90">        SecurityFilter productSyncFilter = new SecurityFilter(jwksUrl, issuer, &quot;product-sync&quot;);</span>
<span class="nc" id="L91">        SecurityFilter stockReserveFilter = new SecurityFilter(jwksUrl, issuer, &quot;stock-reserve&quot;);</span>
<span class="nc" id="L92">        SecurityFilter fulfillmentFilter = new SecurityFilter(jwksUrl, issuer, &quot;order-fulfillment&quot;);</span>

        // --- HTTP Server Setup ---
<span class="nc" id="L95">        int port = 8002;</span>
<span class="nc" id="L96">        HttpServer server = HttpServer.create(new InetSocketAddress(port), 0);</span>

<span class="nc" id="L98">        server.createContext(&quot;/&quot;, (exchange) -&gt; {</span>
<span class="nc" id="L99">            String path = exchange.getRequestURI().getPath();</span>
<span class="nc" id="L100">            logger.info(&quot;Received request: {} {}&quot;, exchange.getRequestMethod(), path);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (&quot;/&quot;.equals(path)) {</span>
<span class="nc" id="L102">                String header = &quot;&lt;div style='display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;'&gt;&quot; +</span>
                                &quot;&lt;button onclick=\&quot;window.location.href='/'\&quot; class='btn btn-primary'&gt;Warehouse Dashboard&lt;/button&gt;&quot; +
                                &quot;&lt;button onclick=\&quot;window.location.href='/logout'\&quot; class='btn btn-secondary'&gt;Logout&lt;/button&gt;&quot; +
                                &quot;&lt;/div&gt;&quot;;

<span class="nc" id="L107">                String html = &quot;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot; + CSS + &quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot; +</span>
                              header +
                              &quot;&lt;h1&gt;Warehouse Service&lt;/h1&gt;&quot; +
                              &quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-primary'&gt;View Products&lt;/button&gt;&quot; +
                              &quot;&lt;button onclick=\&quot;window.location.href='/deliveries'\&quot; class='btn btn-primary'&gt;Deliveries&lt;/button&gt;&quot; +
                              &quot;&lt;button onclick=\&quot;window.location.href='/fulfillment'\&quot; class='btn btn-primary'&gt;Order Fulfillment&lt;/button&gt;&quot; +
                              &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L114">                byte[] bytes = html.getBytes(StandardCharsets.UTF_8);</span>
<span class="nc" id="L115">                exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="nc" id="L116">                exchange.sendResponseHeaders(200, bytes.length);</span>
<span class="nc" id="L117">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L118">                    os.write(bytes);</span>
                }
<span class="nc" id="L120">            } else {</span>
<span class="nc" id="L121">                String response = &quot;404 Not Found&quot;;</span>
<span class="nc" id="L122">                exchange.sendResponseHeaders(404, response.length());</span>
<span class="nc" id="L123">                try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="nc" id="L124">                    os.write(response.getBytes());</span>
                }
            }
<span class="nc" id="L127">            exchange.close();</span>
<span class="nc" id="L128">        });</span>

<span class="nc" id="L130">        server.createContext(&quot;/login&quot;, new LoginHandler(tokenUrl));</span>
        
<span class="nc" id="L132">        server.createContext(&quot;/logout&quot;, (exchange) -&gt; {</span>
<span class="nc" id="L133">            String path = exchange.getRequestURI().getPath();</span>
<span class="nc" id="L134">            logger.info(&quot;Received request: {} {}&quot;, exchange.getRequestMethod(), path);</span>
            
<span class="nc" id="L136">            String host = exchange.getRequestHeaders().getFirst(&quot;Host&quot;);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (host == null) host = &quot;localhost:8445&quot;;</span>
<span class="nc" id="L138">            String baseUrl = &quot;https://&quot; + host;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (baseUrl.endsWith(&quot;/&quot;)) baseUrl = baseUrl.substring(0, baseUrl.length() - 1);</span>

<span class="nc" id="L141">            String currentKeycloakUrl = defaultKeycloakUrl;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (host.contains(&quot;:8445&quot;)) {</span>
<span class="nc" id="L143">                currentKeycloakUrl = &quot;https://&quot; + host.replace(&quot;:8445&quot;, &quot;:8446&quot;);</span>
            }

<span class="nc" id="L146">            String encodedRedirectUri = URLEncoder.encode(baseUrl + &quot;/&quot;, StandardCharsets.UTF_8);</span>
            // Corrected to use post_logout_redirect_uri
<span class="nc" id="L148">            String keycloakLogoutUrl = currentKeycloakUrl + &quot;/realms/webshop-realm/protocol/openid-connect/logout?post_logout_redirect_uri=&quot; + encodedRedirectUri + &quot;&amp;client_id=webshop-client&quot;;</span>

<span class="nc" id="L150">            exchange.getResponseHeaders().add(&quot;Set-Cookie&quot;, &quot;auth_token=; Path=/; Max-Age=0&quot;);</span>
<span class="nc" id="L151">            exchange.getResponseHeaders().set(&quot;Location&quot;, keycloakLogoutUrl);</span>
<span class="nc" id="L152">            exchange.sendResponseHeaders(302, -1);</span>
<span class="nc" id="L153">            exchange.close();</span>
<span class="nc" id="L154">        });</span>

        // UI Contexts
<span class="nc" id="L157">        HttpContext productContext = server.createContext(&quot;/products&quot;, new ProductController(productRepository));</span>
<span class="nc" id="L158">        productContext.getFilters().add(staffFilter);</span>
        
<span class="nc" id="L160">        HttpContext deliveryContext = server.createContext(&quot;/deliveries&quot;, new DeliveryController(deliveryRepository, productRepository, stockService));</span>
<span class="nc" id="L161">        deliveryContext.getFilters().add(staffFilter);</span>
        
        // Fixed: Added orderUpdateService to constructor
<span class="nc" id="L164">        HttpContext fulfillmentContext = server.createContext(&quot;/fulfillment&quot;, new FulfillmentController(fulfillmentOrderRepository, orderUpdateService));</span>
<span class="nc" id="L165">        fulfillmentContext.getFilters().add(staffFilter);</span>

        // API Contexts
<span class="nc" id="L168">        HttpContext productSyncContext = server.createContext(&quot;/api/products/sync&quot;, new ProductSyncController(productRepository));</span>
<span class="nc" id="L169">        productSyncContext.getFilters().add(productSyncFilter);</span>
        
<span class="nc" id="L171">        HttpContext stockReserveContext = server.createContext(&quot;/api/stock/reserve&quot;, new StockReservationController(deliveryRepository, productRepository, stockService));</span>
<span class="nc" id="L172">        stockReserveContext.getFilters().add(stockReserveFilter);</span>
        
<span class="nc" id="L174">        HttpContext orderFulfillmentContext = server.createContext(&quot;/api/fulfillment/order&quot;, new OrderFulfillmentController(fulfillmentOrderRepository));</span>
<span class="nc" id="L175">        orderFulfillmentContext.getFilters().add(fulfillmentFilter);</span>

<span class="nc" id="L177">        server.setExecutor(Executors.newCachedThreadPool());</span>
<span class="nc" id="L178">        server.start();</span>
<span class="nc" id="L179">        logger.info(&quot;Warehouse Service started on port {}&quot;, port);</span>
<span class="nc" id="L180">    }</span>

    static class LoginHandler implements HttpHandler {
        private final String tokenUrl;
        private final HttpClient httpClient;

        public LoginHandler(String tokenUrl) {
<span class="nc" id="L187">            this(tokenUrl, HttpClient.newBuilder().connectTimeout(Duration.ofSeconds(5)).build());</span>
<span class="nc" id="L188">        }</span>

        // Added constructor for testing
<span class="fc" id="L191">        public LoginHandler(String tokenUrl, HttpClient httpClient) {</span>
<span class="fc" id="L192">            this.tokenUrl = tokenUrl;</span>
<span class="fc" id="L193">            this.httpClient = httpClient;</span>
<span class="fc" id="L194">        }</span>

        @Override
        public void handle(HttpExchange t) throws IOException {
<span class="fc" id="L198">            logger.info(&quot;Received request: {} {}&quot;, t.getRequestMethod(), t.getRequestURI().getPath());</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">            if (&quot;POST&quot;.equalsIgnoreCase(t.getRequestMethod())) {</span>
<span class="fc" id="L200">                InputStream is = t.getRequestBody();</span>
<span class="fc" id="L201">                String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L202">                Map&lt;String, String&gt; params = parseFormData(formData);</span>
                
<span class="fc" id="L204">                String username = params.get(&quot;username&quot;);</span>
<span class="fc" id="L205">                String password = params.get(&quot;password&quot;);</span>
                
<span class="fc" id="L207">                String requestBody = &quot;client_id=webshop-client&amp;grant_type=password&amp;username=&quot; + username + &quot;&amp;password=&quot; + password;</span>
                
<span class="fc" id="L209">                HttpRequest request = HttpRequest.newBuilder()</span>
<span class="fc" id="L210">                        .uri(URI.create(tokenUrl))</span>
<span class="fc" id="L211">                        .header(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;)</span>
<span class="fc" id="L212">                        .POST(HttpRequest.BodyPublishers.ofString(requestBody))</span>
<span class="fc" id="L213">                        .build();</span>
                
                try {
<span class="fc" id="L216">                    HttpResponse&lt;String&gt; response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">                    if (response.statusCode() == 200) {</span>
<span class="fc" id="L218">                        String json = response.body();</span>
<span class="fc" id="L219">                        String accessToken = extractToken(json);</span>
<span class="pc bpc" id="L220" title="2 of 4 branches missed.">                        logger.info(&quot;Access Token obtained: {}&quot;, accessToken != null &amp;&amp; !accessToken.isEmpty());</span>
<span class="fc" id="L221">                        t.getResponseHeaders().add(&quot;Set-Cookie&quot;, &quot;auth_token=&quot; + accessToken + &quot;; Path=/; HttpOnly&quot;);</span>
<span class="fc" id="L222">                        redirect(t, &quot;/&quot;);</span>
<span class="fc" id="L223">                    } else {</span>
<span class="fc" id="L224">                        logger.warn(&quot;Login failed for user: {}. Status: {}. Body: {}&quot;, username, response.statusCode(), response.body());</span>
<span class="fc" id="L225">                        sendResponse(t, 401, &quot;&lt;h1&gt;Login Failed&lt;/h1&gt;&lt;p&gt;Invalid credentials&lt;/p&gt;&lt;button onclick=\&quot;window.location.href='/login'\&quot; class='btn btn-primary'&gt;Try Again&lt;/button&gt;&quot;);</span>
                    }
<span class="nc" id="L227">                } catch (InterruptedException e) {</span>
<span class="nc" id="L228">                    logger.error(&quot;Error during login&quot;, e);</span>
<span class="nc" id="L229">                    sendResponse(t, 500, &quot;&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;&quot; + e.getMessage() + &quot;&lt;/p&gt;&quot;);</span>
<span class="fc" id="L230">                }</span>
<span class="fc" id="L231">            } else {</span>
<span class="fc" id="L232">                String body = &quot;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot; + CSS + &quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&lt;h1&gt;Login&lt;/h1&gt;&quot; +</span>
                              &quot;&lt;form action='/login' method='post'&gt;&quot; +
                              &quot;&lt;label&gt;Username&lt;/label&gt;&lt;input type='text' name='username'&gt;&quot; +
                              &quot;&lt;label&gt;Password&lt;/label&gt;&lt;input type='password' name='password'&gt;&quot; +
                              &quot;&lt;button type='submit' class='btn btn-primary'&gt;Login&lt;/button&gt;&quot; +
                              &quot;&lt;/form&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
<span class="fc" id="L238">                sendResponse(t, 200, body);</span>
            }
<span class="fc" id="L240">        }</span>

        private String extractToken(String json) {
<span class="fc" id="L243">            int start = json.indexOf(&quot;\&quot;access_token\&quot;:\&quot;&quot;);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if (start == -1) return null;</span>
<span class="fc" id="L245">            start += 16;</span>
<span class="fc" id="L246">            int end = json.indexOf(&quot;\&quot;&quot;, start);</span>
<span class="fc" id="L247">            return json.substring(start, end);</span>
        }
    }

    private static void sendResponse(HttpExchange t, int status, String body) throws IOException {
<span class="fc" id="L252">        byte[] bytes = body.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L253">        t.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="fc" id="L254">        t.sendResponseHeaders(status, bytes.length);</span>
<span class="fc" id="L255">        try (OutputStream os = t.getResponseBody()) {</span>
<span class="fc" id="L256">            os.write(bytes);</span>
        }
<span class="fc" id="L258">    }</span>

    private static void redirect(HttpExchange t, String location) throws IOException {
<span class="fc" id="L261">        logger.info(&quot;Redirecting to: {}&quot;, location);</span>
<span class="fc" id="L262">        t.getResponseHeaders().set(&quot;Location&quot;, location);</span>
<span class="fc" id="L263">        t.sendResponseHeaders(302, -1);</span>
<span class="fc" id="L264">    }</span>

    private static Map&lt;String, String&gt; parseFormData(String formData) {
<span class="fc" id="L267">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L268">        String[] pairs = formData.split(&quot;&amp;&quot;);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">        for (String pair : pairs) {</span>
<span class="fc" id="L270">            String[] keyValue = pair.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">            if (keyValue.length &gt; 0) {</span>
<span class="fc" id="L272">                String key = URLDecoder.decode(keyValue[0], StandardCharsets.UTF_8);</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                String value = keyValue.length &gt; 1 ? URLDecoder.decode(keyValue[1], StandardCharsets.UTF_8) : &quot;&quot;;</span>
<span class="fc" id="L274">                map.put(key, value);</span>
            }
        }
<span class="fc" id="L277">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>