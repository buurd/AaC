<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Good Project Aggregated Coverage</a> &gt; <a href="index.source.html" class="el_package">com.example.productmanagement</a> &gt; <span class="el_source">ProductController.java</span></div><h1>ProductController.java</h1><pre class="source lang-java linenums">package com.example.productmanagement;

import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class ProductController implements HttpHandler {

    private final ProductRepository repository;
    private final ProductService productService;

<span class="fc" id="L24">    public ProductController(ProductRepository repository, ProductService productService) {</span>
<span class="fc" id="L25">        this.repository = repository;</span>
<span class="fc" id="L26">        this.productService = productService;</span>
<span class="fc" id="L27">    }</span>

    private static final String CSS =
        &quot;body { font-family: Arial, Helvetica, sans-serif; background-color: #F8F9FA; color: #343A40; margin: 0; padding: 20px; }&quot; +
        &quot;.container { max-width: 1200px; margin: 0 auto; background-color: #FFFFFF; padding: 20px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }&quot; +
        &quot;h1 { color: #343A40; }&quot; +
        &quot;table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }&quot; +
        &quot;th { background-color: #007BFF; color: #FFFFFF; padding: 12px; text-align: left; }&quot; +
        &quot;td { padding: 12px; border-bottom: 1px solid #DEE2E6; }&quot; +
        &quot;tr:nth-child(even) { background-color: #F2F2F2; }&quot; +
        &quot;.btn { display: inline-block; padding: 10px 20px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; }&quot; +
        &quot;.btn-primary { background-color: #007BFF; }&quot; +
        &quot;.btn-secondary { background-color: #6C757D; }&quot; +
        &quot;.btn-danger { background-color: #DC3545; }&quot; +
        &quot;input[type='text'], input[type='number'], input[type='submit'], textarea { padding: 8px; border: 1px solid #CED4DA; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }&quot; +
        &quot;label { display: block; font-weight: bold; margin-bottom: 5px; }&quot;;

    private String getHeader() {
<span class="fc" id="L45">        return &quot;&lt;div style='display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;'&gt;&quot; +</span>
               &quot;&lt;div&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/'\&quot; class='btn btn-primary'&gt;PM Dashboard&lt;/button&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-secondary'&gt;Products&lt;/button&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/groups'\&quot; class='btn btn-secondary'&gt;Product Groups&lt;/button&gt;&quot; +
               &quot;&lt;/div&gt;&quot; +
               &quot;&lt;button onclick=\&quot;window.location.href='/logout'\&quot; class='btn btn-secondary'&gt;Logout&lt;/button&gt;&quot; +
               &quot;&lt;/div&gt;&quot;;
    }

    @Override
    public void handle(HttpExchange exchange) throws IOException {
<span class="fc" id="L57">        String path = exchange.getRequestURI().getPath();</span>
<span class="fc" id="L58">        String method = exchange.getRequestMethod();</span>

<span class="pc bpc" id="L60" title="1 of 4 branches missed.">        if (&quot;/products&quot;.equals(path) &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L61">            handleList(exchange);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        } else if (&quot;/products/create&quot;.equals(path)) {</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L64">                handleShowCreateForm(exchange);</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L66">                handleCreate(exchange);</span>
            }
<span class="fc bfc" id="L68" title="All 2 branches covered.">        } else if (path.startsWith(&quot;/products/edit&quot;)) {</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L70">                handleShowEditForm(exchange);</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L72">                handleEdit(exchange);</span>
            }
<span class="fc bfc" id="L74" title="All 2 branches covered.">        } else if (path.startsWith(&quot;/products/delete&quot;)) {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L76">                handleShowDeleteForm(exchange);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L78">                handleDelete(exchange);</span>
            }
<span class="fc bfc" id="L80" title="All 2 branches covered.">        } else if (path.startsWith(&quot;/products/sync&quot;)) {</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L82">                handleSync(exchange);</span>
            }
<span class="pc bpc" id="L84" title="1 of 4 branches missed.">        } else if (&quot;/groups&quot;.equals(path) &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L85">            handleListGroups(exchange);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        } else if (&quot;/groups/create&quot;.equals(path)) {</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L88">                handleShowCreateGroupForm(exchange);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L90">                handleCreateGroup(exchange);</span>
            }
<span class="fc bfc" id="L92" title="All 2 branches covered.">        } else if (path.startsWith(&quot;/groups/generate&quot;)) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L94">                handleShowGenerateVariantsForm(exchange);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            } else if (&quot;POST&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L96">                handleGenerateVariants(exchange);</span>
            }
<span class="fc bfc" id="L98" title="All 2 branches covered.">        } else if (path.startsWith(&quot;/groups/sync&quot;)) {</span>
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            if (&quot;GET&quot;.equalsIgnoreCase(method)) {</span>
<span class="fc" id="L100">                handleSyncGroup(exchange);</span>
            }
        } else {
<span class="fc" id="L103">            sendResponse(exchange, 404, &quot;Not Found&quot;);</span>
        }
<span class="fc" id="L105">    }</span>

    private void handleList(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L109">            List&lt;Product&gt; products = repository.findAll();</span>
<span class="fc" id="L110">            StringBuilder html = new StringBuilder();</span>
<span class="fc" id="L111">            html.append(&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot;).append(CSS).append(&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot;);</span>
<span class="fc" id="L112">            html.append(getHeader());</span>
<span class="fc" id="L113">            html.append(&quot;&lt;h1&gt;Products&lt;/h1&gt;&quot;);</span>
<span class="fc" id="L114">            html.append(&quot;&lt;button onclick=\&quot;window.location.href='/products/create'\&quot; class='btn btn-primary'&gt;Create New Product&lt;/button&gt;&quot;);</span>
<span class="fc" id="L115">            html.append(&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Group&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Attributes&lt;/th&gt;&lt;th&gt;Price&lt;/th&gt;&lt;th&gt;Actions&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">            for (Product p : products) {</span>
<span class="fc" id="L117">                html.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L118">                html.append(&quot;&lt;td&gt;&quot;).append(p.getId()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                html.append(&quot;&lt;td&gt;&quot;).append(p.getGroupId() != null ? p.getGroupId() : &quot;-&quot;).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L120">                html.append(&quot;&lt;td&gt;&quot;).append(p.getName()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L121">                html.append(&quot;&lt;td&gt;&quot;).append(formatAttributes(p.getAttributes())).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L122">                html.append(&quot;&lt;td&gt;&quot;).append(String.format(&quot;%.2f %s&quot;, p.getPrice(), p.getUnit())).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L123">                html.append(&quot;&lt;td&gt;&quot;);</span>
<span class="fc" id="L124">                html.append(&quot;&lt;button onclick=\&quot;window.location.href='/products/edit?id=&quot;).append(p.getId()).append(&quot;'\&quot; class='btn btn-secondary'&gt;Edit&lt;/button&gt;&quot;);</span>
<span class="fc" id="L125">                html.append(&quot;&lt;button onclick=\&quot;window.location.href='/products/delete?id=&quot;).append(p.getId()).append(&quot;'\&quot; class='btn btn-danger'&gt;Delete&lt;/button&gt;&quot;);</span>
<span class="fc" id="L126">                html.append(&quot;&lt;button onclick=\&quot;window.location.href='/products/sync?id=&quot;).append(p.getId()).append(&quot;'\&quot; class='btn btn-primary'&gt;Sync&lt;/button&gt;&quot;);</span>
<span class="fc" id="L127">                html.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L128">                html.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L129">            }</span>
<span class="fc" id="L130">            html.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L131">            sendResponse(exchange, 200, html.toString());</span>
<span class="nc" id="L132">        } catch (SQLException e) {</span>
<span class="nc" id="L133">            e.printStackTrace();</span>
<span class="nc" id="L134">            sendResponse(exchange, 500, &quot;Database error&quot;);</span>
<span class="fc" id="L135">        }</span>
<span class="fc" id="L136">    }</span>

    private void handleShowCreateForm(HttpExchange exchange) throws IOException {
<span class="fc" id="L139">        String form = &quot;&lt;h1&gt;Create Product&lt;/h1&gt;&quot; +</span>
                      &quot;&lt;form action='/products/create' method='post'&gt;&quot; +
                      &quot;&lt;label&gt;Type:&lt;/label&gt;&lt;input type='text' name='type' value='Book'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Name:&lt;/label&gt;&lt;input type='text' name='name'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Description:&lt;/label&gt;&lt;input type='text' name='description'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Price:&lt;/label&gt;&lt;input type='number' step='0.01' name='price'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Unit:&lt;/label&gt;&lt;input type='text' name='unit' value='pcs'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;button type='submit' class='btn btn-primary'&gt;Create&lt;/button&gt;&quot; +
                      &quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-secondary'&gt;Cancel&lt;/button&gt;&quot; +
                      &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L149">        sendResponse(exchange, 200, wrapInContainer(form));</span>
<span class="fc" id="L150">    }</span>

    private void handleCreate(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L154">            Map&lt;String, String&gt; params = parseFormData(exchange.getRequestBody());</span>
<span class="fc" id="L155">            Product p = new Product();</span>
<span class="fc" id="L156">            p.setType(params.get(&quot;type&quot;));</span>
<span class="fc" id="L157">            p.setName(params.get(&quot;name&quot;));</span>
<span class="fc" id="L158">            p.setDescription(params.get(&quot;description&quot;));</span>
<span class="fc" id="L159">            p.setPrice(Double.parseDouble(params.get(&quot;price&quot;)));</span>
<span class="fc" id="L160">            p.setUnit(params.get(&quot;unit&quot;));</span>
<span class="fc" id="L161">            productService.createProduct(p);</span>
<span class="fc" id="L162">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L163">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L164">            e.printStackTrace();</span>
<span class="nc" id="L165">            sendResponse(exchange, 500, &quot;Failed to create product&quot;);</span>
<span class="fc" id="L166">        }</span>
<span class="fc" id="L167">    }</span>

    private void handleShowEditForm(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L171">            int id = Integer.parseInt(getQueryParam(exchange.getRequestURI().getQuery(), &quot;id&quot;));</span>
<span class="fc" id="L172">            Product p = repository.findById(id);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">            if (p == null) {</span>
<span class="nc" id="L174">                sendResponse(exchange, 404, &quot;Product not found&quot;);</span>
<span class="nc" id="L175">                return;</span>
            }
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">            String groupIdVal = p.getGroupId() != null ? String.valueOf(p.getGroupId()) : &quot;&quot;;</span>
            // Ensure attributes are not null to avoid issues in form
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            String attributesVal = p.getAttributes() != null ? p.getAttributes() : &quot;&quot;;</span>
            
<span class="fc" id="L181">            String form = &quot;&lt;h1&gt;Edit Product&lt;/h1&gt;&quot; +</span>
                          &quot;&lt;form action='/products/edit' method='post'&gt;&quot; +
<span class="fc" id="L183">                          &quot;&lt;input type='hidden' name='id' value='&quot; + p.getId() + &quot;'&gt;&quot; +</span>
                          &quot;&lt;input type='hidden' name='groupId' value='&quot; + groupIdVal + &quot;'&gt;&quot; +
                          // Preserve attributes in a hidden field so they aren't lost on update
<span class="fc" id="L186">                          &quot;&lt;input type='hidden' name='attributes' value='&quot; + attributesVal.replace(&quot;'&quot;, &quot;&amp;apos;&quot;) + &quot;'&gt;&quot; +</span>
<span class="fc" id="L187">                          &quot;&lt;label&gt;Type:&lt;/label&gt;&lt;input type='text' name='type' value='&quot; + p.getType() + &quot;'&gt;&lt;br&gt;&quot; +</span>
<span class="fc" id="L188">                          &quot;&lt;label&gt;Name:&lt;/label&gt;&lt;input type='text' name='name' value='&quot; + p.getName() + &quot;'&gt;&lt;br&gt;&quot; +</span>
<span class="fc" id="L189">                          &quot;&lt;label&gt;Description:&lt;/label&gt;&lt;input type='text' name='description' value='&quot; + p.getDescription() + &quot;'&gt;&lt;br&gt;&quot; +</span>
<span class="fc" id="L190">                          &quot;&lt;label&gt;Price:&lt;/label&gt;&lt;input type='number' step='0.01' name='price' value='&quot; + p.getPrice() + &quot;'&gt;&lt;br&gt;&quot; +</span>
<span class="fc" id="L191">                          &quot;&lt;label&gt;Unit:&lt;/label&gt;&lt;input type='text' name='unit' value='&quot; + p.getUnit() + &quot;'&gt;&lt;br&gt;&quot; +</span>
                          &quot;&lt;button type='submit' class='btn btn-primary'&gt;Update&lt;/button&gt;&quot; +
                          &quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-secondary'&gt;Cancel&lt;/button&gt;&quot; +
                          &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L195">            sendResponse(exchange, 200, wrapInContainer(form));</span>
<span class="nc" id="L196">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L197">            e.printStackTrace();</span>
<span class="nc" id="L198">            sendResponse(exchange, 500, &quot;Server error&quot;);</span>
<span class="fc" id="L199">        }</span>
<span class="fc" id="L200">    }</span>

    private void handleEdit(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L204">            Map&lt;String, String&gt; params = parseFormData(exchange.getRequestBody());</span>
<span class="fc" id="L205">            Product p = new Product();</span>
<span class="fc" id="L206">            p.setId(Integer.parseInt(params.get(&quot;id&quot;)));</span>
<span class="fc" id="L207">            String groupIdStr = params.get(&quot;groupId&quot;);</span>
<span class="pc bpc" id="L208" title="3 of 4 branches missed.">            if (groupIdStr != null &amp;&amp; !groupIdStr.isEmpty()) {</span>
<span class="nc" id="L209">                p.setGroupId(Integer.parseInt(groupIdStr));</span>
            }
<span class="fc" id="L211">            p.setType(params.get(&quot;type&quot;));</span>
<span class="fc" id="L212">            p.setName(params.get(&quot;name&quot;));</span>
<span class="fc" id="L213">            p.setDescription(params.get(&quot;description&quot;));</span>
<span class="fc" id="L214">            p.setPrice(Double.parseDouble(params.get(&quot;price&quot;)));</span>
<span class="fc" id="L215">            p.setUnit(params.get(&quot;unit&quot;));</span>
            // Retrieve and set attributes so they are persisted
<span class="fc" id="L217">            String attributes = params.get(&quot;attributes&quot;);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            if (attributes != null) {</span>
<span class="nc" id="L219">                p.setAttributes(attributes);</span>
            }
<span class="fc" id="L221">            productService.updateProduct(p);</span>
<span class="fc" id="L222">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L223">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L224">            e.printStackTrace();</span>
<span class="nc" id="L225">            sendResponse(exchange, 500, &quot;Failed to update product&quot;);</span>
<span class="fc" id="L226">        }</span>
<span class="fc" id="L227">    }</span>

    private void handleShowDeleteForm(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L231">            int id = Integer.parseInt(getQueryParam(exchange.getRequestURI().getQuery(), &quot;id&quot;));</span>
<span class="fc" id="L232">            Product p = repository.findById(id);</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">            if (p == null) {</span>
<span class="nc" id="L234">                sendResponse(exchange, 404, &quot;Product not found&quot;);</span>
<span class="nc" id="L235">                return;</span>
            }
<span class="fc" id="L237">            String form = &quot;&lt;h1&gt;Delete Product&lt;/h1&gt;&quot; +</span>
<span class="fc" id="L238">                          &quot;&lt;p&gt;Are you sure you want to delete '&quot; + p.getName() + &quot;'?&lt;/p&gt;&quot; +</span>
                          &quot;&lt;form action='/products/delete' method='post'&gt;&quot; +
<span class="fc" id="L240">                          &quot;&lt;input type='hidden' name='id' value='&quot; + p.getId() + &quot;'&gt;&quot; +</span>
                          &quot;&lt;button type='submit' class='btn btn-danger'&gt;Delete&lt;/button&gt;&quot; +
                          &quot;&lt;button onclick=\&quot;window.location.href='/products'\&quot; class='btn btn-secondary'&gt;Cancel&lt;/button&gt;&quot; +
                          &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L244">            sendResponse(exchange, 200, wrapInContainer(form));</span>
<span class="nc" id="L245">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L246">            e.printStackTrace();</span>
<span class="nc" id="L247">            sendResponse(exchange, 500, &quot;Server error&quot;);</span>
<span class="fc" id="L248">        }</span>
<span class="fc" id="L249">    }</span>

    private void handleDelete(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L253">            Map&lt;String, String&gt; params = parseFormData(exchange.getRequestBody());</span>
<span class="fc" id="L254">            int id = Integer.parseInt(params.get(&quot;id&quot;));</span>
<span class="fc" id="L255">            productService.deleteProduct(id);</span>
<span class="fc" id="L256">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L257">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L258">            e.printStackTrace();</span>
<span class="nc" id="L259">            sendResponse(exchange, 500, &quot;Failed to delete product&quot;);</span>
<span class="fc" id="L260">        }</span>
<span class="fc" id="L261">    }</span>

    private void handleSync(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L265">            int id = Integer.parseInt(getQueryParam(exchange.getRequestURI().getQuery(), &quot;id&quot;));</span>
<span class="fc" id="L266">            productService.syncProduct(id);</span>
<span class="fc" id="L267">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L268">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L269">            e.printStackTrace();</span>
<span class="nc" id="L270">            sendResponse(exchange, 500, &quot;Failed to sync product&quot;);</span>
<span class="fc" id="L271">        }</span>
<span class="fc" id="L272">    }</span>

    // --- Group Handlers ---

    private void handleListGroups(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L278">            List&lt;ProductGroup&gt; groups = repository.findAllGroups();</span>
<span class="fc" id="L279">            StringBuilder html = new StringBuilder();</span>
<span class="fc" id="L280">            html.append(&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot;).append(CSS).append(&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot;);</span>
<span class="fc" id="L281">            html.append(getHeader());</span>
<span class="fc" id="L282">            html.append(&quot;&lt;h1&gt;Product Groups&lt;/h1&gt;&quot;);</span>
<span class="fc" id="L283">            html.append(&quot;&lt;button onclick=\&quot;window.location.href='/groups/create'\&quot; class='btn btn-primary'&gt;Create New Group&lt;/button&gt;&quot;);</span>
<span class="fc" id="L284">            html.append(&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Base Price&lt;/th&gt;&lt;th&gt;Actions&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&quot;);</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">            for (ProductGroup g : groups) {</span>
<span class="fc" id="L286">                html.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L287">                html.append(&quot;&lt;td&gt;&quot;).append(g.getId()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L288">                html.append(&quot;&lt;td&gt;&quot;).append(g.getName()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L289">                html.append(&quot;&lt;td&gt;&quot;).append(String.format(&quot;%.2f %s&quot;, g.getBasePrice(), g.getBaseUnit())).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L290">                html.append(&quot;&lt;td&gt;&quot;);</span>
<span class="fc" id="L291">                html.append(&quot;&lt;button onclick=\&quot;window.location.href='/groups/generate?id=&quot;).append(g.getId()).append(&quot;'\&quot; class='btn btn-secondary'&gt;Generate Variants&lt;/button&gt;&quot;);</span>
<span class="fc" id="L292">                html.append(&quot;&lt;button onclick=\&quot;window.location.href='/groups/sync?id=&quot;).append(g.getId()).append(&quot;'\&quot; class='btn btn-primary'&gt;Sync All&lt;/button&gt;&quot;);</span>
<span class="fc" id="L293">                html.append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L294">                html.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L295">            }</span>
<span class="fc" id="L296">            html.append(&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L297">            sendResponse(exchange, 200, html.toString());</span>
<span class="nc" id="L298">        } catch (SQLException e) {</span>
<span class="nc" id="L299">            e.printStackTrace();</span>
<span class="nc" id="L300">            sendResponse(exchange, 500, &quot;Database error&quot;);</span>
<span class="fc" id="L301">        }</span>
<span class="fc" id="L302">    }</span>

    private void handleShowCreateGroupForm(HttpExchange exchange) throws IOException {
<span class="fc" id="L305">        String form = &quot;&lt;h1&gt;Create Product Group&lt;/h1&gt;&quot; +</span>
                      &quot;&lt;form action='/groups/create' method='post'&gt;&quot; +
                      &quot;&lt;label&gt;Name:&lt;/label&gt;&lt;input type='text' name='name'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Description:&lt;/label&gt;&lt;input type='text' name='description'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Base Price:&lt;/label&gt;&lt;input type='number' step='0.01' name='basePrice'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;label&gt;Base Unit:&lt;/label&gt;&lt;input type='text' name='baseUnit' value='pcs'&gt;&lt;br&gt;&quot; +
                      &quot;&lt;button type='submit' class='btn btn-primary'&gt;Create&lt;/button&gt;&quot; +
                      &quot;&lt;button onclick=\&quot;window.location.href='/groups'\&quot; class='btn btn-secondary'&gt;Cancel&lt;/button&gt;&quot; +
                      &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L314">        sendResponse(exchange, 200, wrapInContainer(form));</span>
<span class="fc" id="L315">    }</span>

    private void handleCreateGroup(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L319">            Map&lt;String, String&gt; params = parseFormData(exchange.getRequestBody());</span>
<span class="fc" id="L320">            ProductGroup g = new ProductGroup();</span>
<span class="fc" id="L321">            g.setName(params.get(&quot;name&quot;));</span>
<span class="fc" id="L322">            g.setDescription(params.get(&quot;description&quot;));</span>
<span class="fc" id="L323">            g.setBasePrice(Double.parseDouble(params.get(&quot;basePrice&quot;)));</span>
<span class="fc" id="L324">            g.setBaseUnit(params.get(&quot;baseUnit&quot;));</span>
<span class="fc" id="L325">            productService.createProductGroup(g);</span>
<span class="fc" id="L326">            redirect(exchange, &quot;/groups&quot;);</span>
<span class="nc" id="L327">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L328">            e.printStackTrace();</span>
<span class="nc" id="L329">            sendResponse(exchange, 500, &quot;Failed to create group&quot;);</span>
<span class="fc" id="L330">        }</span>
<span class="fc" id="L331">    }</span>

    private void handleShowGenerateVariantsForm(HttpExchange exchange) throws IOException {
<span class="fc" id="L334">        int id = Integer.parseInt(getQueryParam(exchange.getRequestURI().getQuery(), &quot;id&quot;));</span>
<span class="fc" id="L335">        String form = &quot;&lt;h1&gt;Generate Variants&lt;/h1&gt;&quot; +</span>
                      &quot;&lt;form action='/groups/generate' method='post'&gt;&quot; +
                      &quot;&lt;input type='hidden' name='id' value='&quot; + id + &quot;'&gt;&quot; +
                      &quot;&lt;label&gt;Attributes (Format: Name: Value1, Value2; Name2: Value3, Value4):&lt;/label&gt;&lt;br&gt;&quot; +
                      &quot;&lt;textarea name='attributes' rows='5' cols='50'&gt;Color: Red, Blue\nSize: S, M, L&lt;/textarea&gt;&lt;br&gt;&quot; +
                      &quot;&lt;button type='submit' class='btn btn-primary'&gt;Generate&lt;/button&gt;&quot; +
                      &quot;&lt;button onclick=\&quot;window.location.href='/groups'\&quot; class='btn btn-secondary'&gt;Cancel&lt;/button&gt;&quot; +
                      &quot;&lt;/form&gt;&quot;;
<span class="fc" id="L343">        sendResponse(exchange, 200, wrapInContainer(form));</span>
<span class="fc" id="L344">    }</span>

    private void handleGenerateVariants(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L348">            Map&lt;String, String&gt; params = parseFormData(exchange.getRequestBody());</span>
<span class="fc" id="L349">            int id = Integer.parseInt(params.get(&quot;id&quot;));</span>
<span class="fc" id="L350">            String attributesRaw = params.get(&quot;attributes&quot;);</span>
            
<span class="fc" id="L352">            Map&lt;String, List&lt;String&gt;&gt; attributes = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">            if (attributesRaw != null) {</span>
<span class="fc" id="L354">                String[] lines = attributesRaw.split(&quot;\\r?\\n&quot;);</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">                for (String line : lines) {</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                    if (line.trim().isEmpty()) continue;</span>
<span class="fc" id="L357">                    String[] parts = line.split(&quot;:&quot;);</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">                    if (parts.length == 2) {</span>
<span class="fc" id="L359">                        String key = parts[0].trim();</span>
<span class="fc" id="L360">                        List&lt;String&gt; values = Arrays.stream(parts[1].split(&quot;,&quot;))</span>
<span class="fc" id="L361">                                                  .map(String::trim)</span>
<span class="fc" id="L362">                                                  .collect(Collectors.toList());</span>
<span class="fc" id="L363">                        attributes.put(key, values);</span>
                    }
                }
            }
            
<span class="fc" id="L368">            productService.generateVariants(id, attributes);</span>
<span class="fc" id="L369">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L370">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L371">            e.printStackTrace();</span>
<span class="nc" id="L372">            sendResponse(exchange, 500, &quot;Failed to generate variants&quot;);</span>
<span class="fc" id="L373">        }</span>
<span class="fc" id="L374">    }</span>

    private void handleSyncGroup(HttpExchange exchange) throws IOException {
        try {
<span class="fc" id="L378">            int id = Integer.parseInt(getQueryParam(exchange.getRequestURI().getQuery(), &quot;id&quot;));</span>
<span class="fc" id="L379">            productService.syncGroup(id);</span>
<span class="fc" id="L380">            redirect(exchange, &quot;/products&quot;);</span>
<span class="nc" id="L381">        } catch (SQLException | NumberFormatException e) {</span>
<span class="nc" id="L382">            e.printStackTrace();</span>
<span class="nc" id="L383">            sendResponse(exchange, 500, &quot;Failed to sync group&quot;);</span>
<span class="fc" id="L384">        }</span>
<span class="fc" id="L385">    }</span>

    private String getQueryParam(String query, String paramName) {
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">        if (query == null) return null;</span>
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        for (String param : query.split(&quot;&amp;&quot;)) {</span>
<span class="fc" id="L390">            String[] pair = param.split(&quot;=&quot;);</span>
<span class="pc bpc" id="L391" title="2 of 4 branches missed.">            if (pair.length &gt; 1 &amp;&amp; pair[0].equals(paramName)) {</span>
<span class="fc" id="L392">                return URLDecoder.decode(pair[1], StandardCharsets.UTF_8);</span>
            }
        }
<span class="nc" id="L395">        return null;</span>
    }

    private Map&lt;String, String&gt; parseFormData(InputStream is) throws IOException {
<span class="fc" id="L399">        String formData = new String(is.readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L400">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">        for (String pair : formData.split(&quot;&amp;&quot;)) {</span>
<span class="fc" id="L402">            int idx = pair.indexOf(&quot;=&quot;);</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            if (idx &gt; 0) {</span>
<span class="fc" id="L404">                map.put(URLDecoder.decode(pair.substring(0, idx), StandardCharsets.UTF_8), URLDecoder.decode(pair.substring(idx + 1), StandardCharsets.UTF_8));</span>
            }
        }
<span class="fc" id="L407">        return map;</span>
    }

    private void sendResponse(HttpExchange exchange, int code, String body) throws IOException {
<span class="fc" id="L411">        byte[] bytes = body.getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L412">        exchange.getResponseHeaders().set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;);</span>
<span class="fc" id="L413">        exchange.sendResponseHeaders(code, bytes.length);</span>
<span class="fc" id="L414">        try (OutputStream os = exchange.getResponseBody()) {</span>
<span class="fc" id="L415">            os.write(bytes);</span>
        }
<span class="fc" id="L417">    }</span>

    private void redirect(HttpExchange exchange, String location) throws IOException {
<span class="fc" id="L420">        exchange.getResponseHeaders().set(&quot;Location&quot;, location);</span>
<span class="fc" id="L421">        exchange.sendResponseHeaders(302, -1);</span>
<span class="fc" id="L422">        exchange.close();</span>
<span class="fc" id="L423">    }</span>

    private String wrapInContainer(String content) {
<span class="fc" id="L426">        return &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;style&gt;&quot; + CSS + &quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;div class='container'&gt;&quot; + getHeader() + content + &quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
    }

    private String formatAttributes(String json) {
<span class="pc bpc" id="L430" title="3 of 4 branches missed.">        if (json == null || json.isEmpty()) return &quot;-&quot;;</span>
<span class="nc" id="L431">        return json.replace(&quot;{&quot;, &quot;&quot;).replace(&quot;}&quot;, &quot;&quot;).replace(&quot;\&quot;&quot;, &quot;&quot;).replace(&quot;,&quot;, &quot;, &quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>